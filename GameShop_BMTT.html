<!doctype html>
<html lang="vi">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GameShop - Mua Bán Tài Khoản Game</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style>
        body {
            box-sizing: border-box;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .bounce {
            animation: bounce 0.6s ease-in-out;
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast.success { background: #10b981; }
        .toast.error { background: #ef4444; }
        .product-card {
            transition: all 0.3s ease;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 min-h-full"><!-- Navigation -->
  <nav class="bg-black/20 backdrop-blur-md border-b border-white/10 sticky top-0 z-50">
   <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center h-16">
     <div class="flex items-center space-x-8">
      <div class="text-2xl font-bold text-white">
       🎮 GameShop
      </div>
      <div class="hidden md:flex space-x-6"><button onclick="showPage('home')" class="text-white hover:text-blue-300 transition-colors">Trang chủ</button> <button onclick="showPage('categories')" class="text-white hover:text-blue-300 transition-colors">Danh mục</button> <button onclick="showPage('sell')" class="text-white hover:text-blue-300 transition-colors">Đăng bán</button>
      </div>
     </div>
     <div class="flex items-center space-x-4">
      <div id="userInfo" class="hidden items-center space-x-4"><span id="userBalance" class="text-yellow-300 font-semibold"></span> <button onclick="showPage('cart')" class="relative text-white hover:text-blue-300"> 🛒 <span id="cartCount" class="absolute -top-2 -right-2 bg-red-500 text-xs rounded-full px-1">0</span> </button> <button onclick="showPage('messages')" class="relative text-white hover:text-blue-300"> 💬 <span id="messageCount" class="absolute -top-2 -right-2 bg-red-500 text-xs rounded-full px-1 hidden">0</span> </button> <button onclick="showPage('profile')" class="text-white hover:text-blue-300">👤 Tài khoản</button> <button id="adminBtn" onclick="showPage('admin')" class="hidden text-yellow-300 hover:text-yellow-100">👑 Quản trị</button> <button onclick="logout()" class="text-red-300 hover:text-red-100">Đăng xuất</button>
      </div>
      <div id="authButtons" class="flex space-x-2"><button onclick="showPage('login')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">Đăng nhập</button> <button onclick="showPage('register')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">Đăng ký</button>
      </div>
     </div>
    </div>
   </div>
  </nav><!-- Main Content -->
  <div id="mainContent" class="max-w-7xl mx-auto px-4 py-8"><!-- Home Page -->
   <div id="homePage" class="page"><!-- Banner -->
    <div class="bg-gradient-to-r from-purple-600 to-blue-600 rounded-2xl p-8 mb-8 text-white">
     <h1 class="text-4xl font-bold mb-4">Chào mừng đến GameShop! 🎮</h1>
     <p class="text-xl mb-6">Nơi mua bán tài khoản game uy tín #1 Việt Nam</p><button onclick="showPage('categories')" class="bg-white text-purple-600 px-6 py-3 rounded-lg font-semibold hover:bg-gray-100 transition-colors"> Khám phá ngay </button>
    </div><!-- Featured Products -->
    <div class="mb-8">
     <h2 class="text-2xl font-bold text-white mb-6">🔥 Sản phẩm nổi bật</h2>
     <div id="featuredProducts" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"><!-- Products will be loaded here -->
     </div>
    </div><!-- Game Categories -->
    <div>
     <h2 class="text-2xl font-bold text-white mb-6">🎯 Danh mục game</h2>
     <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
      <div class="bg-white/10 backdrop-blur-md rounded-xl p-4 text-center hover:bg-white/20 transition-all cursor-pointer" onclick="filterByGame('Liên Quân')">
       <div class="text-4xl mb-2">
        ⚔️
       </div>
       <div class="text-white font-semibold">
        Liên Quân
       </div>
       <div class="text-gray-300 text-sm" id="lienquan-count">
        0 tài khoản
       </div>
      </div>
      <div class="bg-white/10 backdrop-blur-md rounded-xl p-4 text-center hover:bg-white/20 transition-all cursor-pointer" onclick="filterByGame('PUBG')">
       <div class="text-4xl mb-2">
        🔫
       </div>
       <div class="text-white font-semibold">
        PUBG
       </div>
       <div class="text-gray-300 text-sm" id="pubg-count">
        0 tài khoản
       </div>
      </div>
      <div class="bg-white/10 backdrop-blur-md rounded-xl p-4 text-center hover:bg-white/20 transition-all cursor-pointer" onclick="filterByGame('Free Fire')">
       <div class="text-4xl mb-2">
        🔥
       </div>
       <div class="text-white font-semibold">
        Free Fire
       </div>
       <div class="text-gray-300 text-sm" id="freefire-count">
        0 tài khoản
       </div>
      </div>
      <div class="bg-white/10 backdrop-blur-md rounded-xl p-4 text-center hover:bg-white/20 transition-all cursor-pointer" onclick="filterByGame('Genshin')">
       <div class="text-4xl mb-2">
        ✨
       </div>
       <div class="text-white font-semibold">
        Genshin
       </div>
       <div class="text-gray-300 text-sm" id="genshin-count">
        0 tài khoản
       </div>
      </div>
      <div class="bg-white/10 backdrop-blur-md rounded-xl p-4 text-center hover:bg-white/20 transition-all cursor-pointer" onclick="filterByGame('Minecraft')">
       <div class="text-4xl mb-2">
        🧱
       </div>
       <div class="text-white font-semibold">
        Minecraft
       </div>
       <div class="text-gray-300 text-sm" id="minecraft-count">
        0 tài khoản
       </div>
      </div>
      <div class="bg-white/10 backdrop-blur-md rounded-xl p-4 text-center hover:bg-white/20 transition-all cursor-pointer" onclick="filterByGame('Roblox')">
       <div class="text-4xl mb-2">
        🎲
       </div>
       <div class="text-white font-semibold">
        Roblox
       </div>
       <div class="text-gray-300 text-sm" id="roblox-count">
        0 tài khoản
       </div>
      </div>
     </div>
    </div>
   </div><!-- Login Page -->
   <div id="loginPage" class="page hidden">
    <div class="max-w-md mx-auto bg-white/10 backdrop-blur-md rounded-2xl p-8">
     <h2 class="text-3xl font-bold text-white mb-6 text-center">🔐 Đăng nhập</h2>
     <form id="loginForm" onsubmit="handleLogin(event)">
      <div class="mb-4"><label class="block text-white mb-2">Email</label> <input type="email" id="loginEmail" required class="w-full px-4 py-3 rounded-lg bg-white/20 text-white placeholder-gray-300 border border-white/30 focus:border-blue-400 focus:outline-none">
      </div>
      <div class="mb-6"><label class="block text-white mb-2">Mật khẩu</label> <input type="password" id="loginPassword" required class="w-full px-4 py-3 rounded-lg bg-white/20 text-white placeholder-gray-300 border border-white/30 focus:border-blue-400 focus:outline-none">
      </div><button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold transition-colors"> Đăng nhập </button>
     </form>
     <div class="mt-4 text-center space-y-2"><button onclick="showPage('register')" class="block text-blue-300 hover:text-blue-100">Chưa có tài khoản? Đăng ký ngay</button> <button onclick="showPage('forgot')" class="block text-yellow-300 hover:text-yellow-100">🔑 Quên mật khẩu?</button>
     </div>
    </div>
   </div><!-- Forgot Password Page -->
   <div id="forgotPage" class="page hidden">
    <div class="max-w-md mx-auto bg-white/10 backdrop-blur-md rounded-2xl p-8">
     <h2 class="text-3xl font-bold text-white mb-6 text-center">🔑 Quên mật khẩu</h2><!-- Step 1: Enter Email -->
     <div id="forgotStep1">
      <p class="text-gray-300 text-center mb-6">Nhập email đã đăng ký để lấy lại mật khẩu</p>
      <form id="forgotEmailForm" onsubmit="handleForgotPassword(event)">
       <div class="mb-6"><label class="block text-white mb-2">Email đã đăng ký</label> <input type="email" id="forgotEmail" required class="w-full px-4 py-3 rounded-lg bg-white/20 text-white placeholder-gray-300 border border-white/30 focus:border-blue-400 focus:outline-none" placeholder="Nhập email của bạn...">
       </div><button type="submit" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white py-3 rounded-lg font-semibold transition-colors"> 🔍 Tìm tài khoản </button>
      </form>
     </div><!-- Step 2: OTP Verification -->
     <div id="forgotStep2" class="hidden">
      <div class="bg-green-500/20 border border-green-500/50 rounded-lg p-4 mb-4">
       <p class="text-green-200 text-center">✅ Tìm thấy tài khoản!</p>
       <p class="text-green-300 text-center text-sm mt-1">Mã OTP đã được gửi đến email của bạn</p>
      </div>
      <div class="bg-yellow-500/20 border border-yellow-500/50 rounded-lg p-4 mb-4">
       <p class="text-yellow-200 text-center">Mã OTP của bạn: <span id="forgotOtpCode" class="font-bold text-yellow-100"></span></p>
       <p class="text-yellow-300 text-center text-sm">Thời gian còn lại: <span id="forgotOtpTimer" class="font-bold">60</span>s</p>
      </div>
      <form id="forgotOtpForm" onsubmit="verifyForgotOTP(event)">
       <div class="mb-4"><label class="block text-white mb-2">Nhập mã OTP</label> <input type="text" id="forgotOtpInput" required maxlength="6" class="w-full px-4 py-3 rounded-lg bg-white/20 text-white placeholder-gray-300 border border-white/30 focus:border-blue-400 focus:outline-none text-center text-2xl tracking-widest" placeholder="000000">
       </div><button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold transition-colors"> ✅ Xác thực OTP </button>
      </form>
     </div><!-- Step 3: Reset Password -->
     <div id="forgotStep3" class="hidden">
      <div class="bg-green-500/20 border border-green-500/50 rounded-lg p-4 mb-4">
       <p class="text-green-200 text-center">🎉 Xác thực thành công!</p>
       <p class="text-green-300 text-center text-sm mt-1">Bây giờ bạn có thể đặt mật khẩu mới</p>
      </div>
      <form id="resetPasswordForm" onsubmit="handleResetPassword(event)">
       <div class="mb-4"><label class="block text-white mb-2">Mật khẩu mới</label> <input type="password" id="newPasswordReset" required minlength="6" class="w-full px-4 py-3 rounded-lg bg-white/20 text-white placeholder-gray-300 border border-white/30 focus:border-blue-400 focus:outline-none" placeholder="Nhập mật khẩu mới...">
       </div>
       <div class="mb-6"><label class="block text-white mb-2">Xác nhận mật khẩu mới</label> <input type="password" id="confirmPasswordReset" required minlength="6" class="w-full px-4 py-3 rounded-lg bg-white/20 text-white placeholder-gray-300 border border-white/30 focus:border-blue-400 focus:outline-none" placeholder="Nhập lại mật khẩu mới...">
       </div><button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-semibold transition-colors"> 🔒 Đặt lại mật khẩu </button>
      </form>
     </div>
     <div class="mt-4 text-center"><button onclick="showPage('login')" class="text-blue-300 hover:text-blue-100">← Quay lại đăng nhập</button>
     </div>
    </div>
   </div><!-- Register Page -->
   <div id="registerPage" class="page hidden">
    <div class="max-w-md mx-auto bg-white/10 backdrop-blur-md rounded-2xl p-8">
     <h2 class="text-3xl font-bold text-white mb-6 text-center">📝 Đăng ký</h2>
     <form id="registerForm" onsubmit="handleRegister(event)">
      <div class="mb-4"><label class="block text-white mb-2">Họ tên</label> <input type="text" id="registerName" required class="w-full px-4 py-3 rounded-lg bg-white/20 text-white placeholder-gray-300 border border-white/30 focus:border-blue-400 focus:outline-none">
      </div>
      <div class="mb-4"><label class="block text-white mb-2">Email</label> <input type="email" id="registerEmail" required class="w-full px-4 py-3 rounded-lg bg-white/20 text-white placeholder-gray-300 border border-white/30 focus:border-blue-400 focus:outline-none">
      </div>
      <div class="mb-4"><label class="block text-white mb-2">Mật khẩu</label> <input type="password" id="registerPassword" required minlength="8" class="w-full px-4 py-3 rounded-lg bg-white/20 text-white placeholder-gray-300 border border-white/30 focus:border-blue-400 focus:outline-none" placeholder="Tối thiểu 8 ký tự...">
       <div class="mt-2 text-sm">
        <div class="text-gray-300 mb-1">
         Mật khẩu phải có:
        </div>
        <div id="passwordRequirements" class="space-y-1 text-xs">
         <div id="req-length" class="text-red-400">
          • Ít nhất 8 ký tự
         </div>
         <div id="req-uppercase" class="text-red-400">
          • Ít nhất 1 chữ hoa (A-Z)
         </div>
         <div id="req-number" class="text-red-400">
          • Ít nhất 1 số (0-9)
         </div>
         <div id="req-special" class="text-red-400">
          • Ít nhất 1 ký tự đặc biệt (!@#$%^&amp;*)
         </div>
        </div>
       </div>
      </div>
      <div class="mb-6"><label class="block text-white mb-2">Xác nhận mật khẩu</label> <input type="password" id="confirmPassword" required class="w-full px-4 py-3 rounded-lg bg-white/20 text-white placeholder-gray-300 border border-white/30 focus:border-blue-400 focus:outline-none">
      </div><button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-semibold transition-colors"> Đăng ký </button>
     </form>
     <div id="otpSection" class="hidden mt-6">
      <div class="bg-yellow-500/20 border border-yellow-500/50 rounded-lg p-4 mb-4">
       <p class="text-yellow-200 text-center">Mã OTP của bạn: <span id="otpCode" class="font-bold text-yellow-100"></span></p>
       <p class="text-yellow-300 text-center text-sm">Thời gian còn lại: <span id="otpTimer" class="font-bold">60</span>s</p>
      </div><input type="text" id="otpInput" placeholder="Nhập mã OTP" class="w-full px-4 py-3 rounded-lg bg-white/20 text-white placeholder-gray-300 border border-white/30 focus:border-blue-400 focus:outline-none mb-4"> <button onclick="verifyOTP()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold transition-colors"> Xác thực OTP </button>
     </div>
    </div>
   </div><!-- Categories Page -->
   <div id="categoriesPage" class="page hidden">
    <div class="mb-6">
     <h2 class="text-3xl font-bold text-white mb-4">🎮 Danh mục sản phẩm</h2>
     <div class="flex flex-wrap gap-2 mb-6"><button onclick="filterProducts('all')" class="filter-btn bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">Tất cả</button> <button onclick="filterProducts('Liên Quân')" class="filter-btn bg-white/20 text-white px-4 py-2 rounded-lg hover:bg-white/30 transition-colors">Liên Quân</button> <button onclick="filterProducts('PUBG')" class="filter-btn bg-white/20 text-white px-4 py-2 rounded-lg hover:bg-white/30 transition-colors">PUBG</button> <button onclick="filterProducts('Free Fire')" class="filter-btn bg-white/20 text-white px-4 py-2 rounded-lg hover:bg-white/30 transition-colors">Free Fire</button> <button onclick="filterProducts('Genshin')" class="filter-btn bg-white/20 text-white px-4 py-2 rounded-lg hover:bg-white/30 transition-colors">Genshin</button>
     </div>
    </div>
    <div id="productsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"><!-- Products will be loaded here -->
    </div>
   </div><!-- Sell Page -->
   <div id="sellPage" class="page hidden">
    <div class="max-w-2xl mx-auto bg-white/10 backdrop-blur-md rounded-2xl p-8">
     <h2 class="text-3xl font-bold text-white mb-6 text-center">💰 Đăng bán tài khoản</h2>
     <form id="sellForm" onsubmit="handleSellAccount(event)">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
       <div><label class="block text-white mb-2">Tên game</label> <select id="sellGame" required class="w-full px-4 py-3 rounded-lg bg-white/20 text-white border border-white/30 focus:border-blue-400 focus:outline-none"> <option value="">Chọn game</option> <option value="Liên Quân">Liên Quân Mobile</option> <option value="PUBG">PUBG Mobile</option> <option value="Free Fire">Free Fire</option> <option value="Genshin">Genshin Impact</option> <option value="Minecraft">Minecraft</option> <option value="Roblox">Roblox</option> </select>
       </div>
       <div><label class="block text-white mb-2">Giá bán (VNĐ)</label> <input type="number" id="sellPrice" required min="1000" class="w-full px-4 py-3 rounded-lg bg-white/20 text-white placeholder-gray-300 border border-white/30 focus:border-blue-400 focus:outline-none">
       </div>
      </div>
      <div class="mt-6"><label class="block text-white mb-2">Mô tả tài khoản</label> <textarea id="sellDescription" required rows="4" class="w-full px-4 py-3 rounded-lg bg-white/20 text-white placeholder-gray-300 border border-white/30 focus:border-blue-400 focus:outline-none" placeholder="Mô tả chi tiết về tài khoản..."></textarea>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
       <div><label class="block text-white mb-2">Tài khoản</label> <input type="text" id="sellUsername" required class="w-full px-4 py-3 rounded-lg bg-white/20 text-white placeholder-gray-300 border border-white/30 focus:border-blue-400 focus:outline-none">
       </div>
       <div><label class="block text-white mb-2">Mật khẩu</label> <input type="password" id="sellPassword" required class="w-full px-4 py-3 rounded-lg bg-white/20 text-white placeholder-gray-300 border border-white/30 focus:border-blue-400 focus:outline-none">
       </div>
      </div>
      <div class="mt-6"><label class="block text-white mb-2">Hình ảnh tài khoản</label> <input type="file" id="sellImage" accept="image/*" class="w-full px-4 py-3 rounded-lg bg-white/20 text-white border border-white/30 focus:border-blue-400 focus:outline-none">
      </div><button type="submit" class="w-full mt-6 bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-semibold transition-colors"> Đăng bán tài khoản </button>
     </form>
    </div>
   </div><!-- Cart Page -->
   <div id="cartPage" class="page hidden">
    <div class="max-w-4xl mx-auto">
     <h2 class="text-3xl font-bold text-white mb-6">🛒 Giỏ hàng của bạn</h2>
     <div id="cartItems" class="space-y-4 mb-6"><!-- Cart items will be loaded here -->
     </div>
     <div class="bg-white/10 backdrop-blur-md rounded-xl p-6">
      <div class="flex justify-between items-center text-white text-xl font-bold mb-4"><span>Tổng cộng:</span> <span id="cartTotal">0 VNĐ</span>
      </div><button onclick="checkout()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-semibold transition-colors"> Thanh toán </button>
     </div>
    </div>
   </div><!-- Messages Page -->
   <div id="messagesPage" class="page hidden">
    <div class="max-w-4xl mx-auto">
     <h2 class="text-3xl font-bold text-white mb-6">💬 Tin nhắn</h2>
     <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 h-[600px] flex flex-col"><!-- Chat Header -->
      <div class="border-b border-white/20 pb-4 mb-4">
       <div class="flex items-center space-x-3">
        <div class="w-10 h-10 bg-yellow-600 rounded-full flex items-center justify-center">
         👑
        </div>
        <div>
         <div class="text-white font-semibold">
          Hỗ trợ khách hàng
         </div>
         <div class="text-green-400 text-sm">
          ● Đang hoạt động
         </div>
        </div>
       </div>
      </div><!-- Messages Container -->
      <div id="messagesContainer" class="flex-1 overflow-y-auto space-y-4 mb-4 pr-2">
       <div class="flex items-start space-x-3">
        <div class="w-8 h-8 bg-yellow-600 rounded-full flex items-center justify-center text-sm">
         👑
        </div>
        <div class="bg-white/20 rounded-lg p-3 max-w-xs">
         <div class="text-white text-sm">
          Xin chào! Tôi có thể giúp gì cho bạn?
         </div>
         <div class="text-gray-400 text-xs mt-1">
          Hôm nay
         </div>
        </div>
       </div>
      </div><!-- Message Input -->
      <form id="messageForm" onsubmit="sendMessage(event)" class="flex space-x-3"><input type="text" id="messageInput" placeholder="Nhập tin nhắn..." required class="flex-1 px-4 py-3 rounded-lg bg-white/20 text-white placeholder-gray-300 border border-white/30 focus:border-blue-400 focus:outline-none"> <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors"> Gửi </button>
      </form>
     </div>
    </div>
   </div><!-- Profile Page -->
   <div id="profilePage" class="page hidden">
    <div class="max-w-4xl mx-auto">
     <h2 class="text-3xl font-bold text-white mb-6">👤 Tài khoản của tôi</h2>
     <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="bg-white/10 backdrop-blur-md rounded-xl p-6">
       <h3 class="text-xl font-bold text-white mb-4">Thông tin cá nhân</h3>
       <div id="userProfileInfo" class="space-y-3 text-white"><!-- User info will be loaded here -->
       </div><button onclick="showRechargeForm()" class="w-full mt-4 bg-yellow-600 hover:bg-yellow-700 text-white py-2 rounded-lg font-semibold transition-colors"> 💰 Nạp tiền </button> <button onclick="showChangePasswordForm()" class="w-full mt-2 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-semibold transition-colors"> 🔒 Đổi mật khẩu </button>
      </div>
      <div class="lg:col-span-2">
       <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 mb-6">
        <h3 class="text-xl font-bold text-white mb-4">📋 Lịch sử mua hàng</h3>
        <div id="purchaseHistory" class="space-y-3"><!-- Purchase history will be loaded here -->
        </div>
       </div>
       <div class="bg-white/10 backdrop-blur-md rounded-xl p-6">
        <h3 class="text-xl font-bold text-white mb-4">🎮 Tài khoản đang bán</h3>
        <div id="sellingAccounts" class="space-y-3"><!-- Selling accounts will be loaded here -->
        </div>
       </div>
      </div>
     </div>
     <div id="adminSecurity" class="admin-tab hidden bg-white/10 backdrop-blur-md rounded-2xl p-6">
      <h3 class="text-xl font-bold text-white mb-6">🛡️ Quản lý bảo mật</h3><!-- Security Overview -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
       <div class="bg-gradient-to-r from-red-600 to-red-700 rounded-xl p-4 text-center">
        <div class="text-white text-2xl font-bold" id="blockedIPCount">
         0
        </div>
        <div class="text-red-100 text-sm">
         IP bị chặn
        </div>
       </div>
       <div class="bg-gradient-to-r from-yellow-600 to-yellow-700 rounded-xl p-4 text-center">
        <div class="text-white text-2xl font-bold" id="securityAlertCountDisplay">
         0
        </div>
        <div class="text-yellow-100 text-sm">
         Cảnh báo chưa xử lý
        </div>
       </div>
       <div class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-xl p-4 text-center">
        <div class="text-white text-2xl font-bold" id="totalFailedAttempts">
         0
        </div>
        <div class="text-blue-100 text-sm">
         Lần thử thất bại hôm nay
        </div>
       </div>
      </div><!-- Security Tabs -->
      <div class="flex flex-wrap gap-2 mb-6"><button onclick="showSecurityTab('alerts')" class="security-tab-btn bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">🚨 Cảnh báo</button> <button onclick="showSecurityTab('blocked')" class="security-tab-btn bg-white/20 text-white px-4 py-2 rounded-lg hover:bg-white/30 transition-colors">🔒 IP bị chặn</button> <button onclick="showSecurityTab('logs')" class="security-tab-btn bg-white/20 text-white px-4 py-2 rounded-lg hover:bg-white/30 transition-colors">📋 Nhật ký</button> <button onclick="showSecurityTab('settings')" class="security-tab-btn bg-white/20 text-white px-4 py-2 rounded-lg hover:bg-white/30 transition-colors">⚙️ Cài đặt</button>
      </div><!-- Security Alerts Tab -->
      <div id="securityAlertsTab" class="security-tab">
       <h4 class="text-lg font-bold text-white mb-4">🚨 Cảnh báo bảo mật</h4>
       <div id="securityAlertsList" class="space-y-3"><!-- Security alerts will be loaded here -->
       </div>
      </div><!-- Blocked IPs Tab -->
      <div id="securityBlockedTab" class="security-tab hidden">
       <h4 class="text-lg font-bold text-white mb-4">🔒 Danh sách IP bị chặn</h4>
       <div id="blockedIPsList" class="space-y-3"><!-- Blocked IPs will be loaded here -->
       </div>
      </div><!-- Security Logs Tab -->
      <div id="securityLogsTab" class="security-tab hidden">
       <h4 class="text-lg font-bold text-white mb-4">📋 Nhật ký bảo mật</h4>
       <div class="mb-4 flex flex-wrap gap-2"><button onclick="filterSecurityLogs('all')" class="log-filter-btn bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 transition-colors">Tất cả</button> <button onclick="filterSecurityLogs('login')" class="log-filter-btn bg-white/20 text-white px-3 py-1 rounded text-sm hover:bg-white/30 transition-colors">Đăng nhập</button> <button onclick="filterSecurityLogs('failed_login')" class="log-filter-btn bg-white/20 text-white px-3 py-1 rounded text-sm hover:bg-white/30 transition-colors">Thất bại</button> <button onclick="filterSecurityLogs('ip_blocked')" class="log-filter-btn bg-white/20 text-white px-3 py-1 rounded text-sm hover:bg-white/30 transition-colors">Chặn IP</button> <button onclick="filterSecurityLogs('purchase')" class="log-filter-btn bg-white/20 text-white px-3 py-1 rounded text-sm hover:bg-white/30 transition-colors">Mua hàng</button>
       </div>
       <div id="securityLogsList" class="space-y-3 max-h-[500px] overflow-y-auto"><!-- Security logs will be loaded here -->
       </div>
      </div><!-- Security Settings Tab -->
      <div id="securitySettingsTab" class="security-tab hidden">
       <h4 class="text-lg font-bold text-white mb-6">⚙️ Cài đặt bảo mật</h4><!-- Current Settings -->
       <div class="bg-white/5 rounded-lg p-6 mb-6">
        <h5 class="text-white font-semibold mb-4">📊 Cấu hình hiện tại</h5>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
         <div class="bg-white/5 rounded-lg p-3">
          <div class="text-gray-300">
           Số lần thử tối đa:
          </div>
          <div class="text-white font-bold text-lg">
           ${THROTTLE_CONFIG.maxAttempts} lần
          </div>
         </div>
         <div class="bg-white/5 rounded-lg p-3">
          <div class="text-gray-300">
           Khung thời gian:
          </div>
          <div class="text-white font-bold text-lg">
           ${THROTTLE_CONFIG.timeWindow / 60000} phút
          </div>
         </div>
         <div class="bg-white/5 rounded-lg p-3">
          <div class="text-gray-300">
           Thời gian chặn:
          </div>
          <div class="text-white font-bold text-lg">
           ${THROTTLE_CONFIG.blockDuration / 60000} phút
          </div>
         </div>
        </div>
       </div><!-- Slack Integration Status -->
       <div class="bg-white/5 rounded-lg p-6 mb-6">
        <h5 class="text-white font-semibold mb-4">📱 Tích hợp Slack</h5>
        <div class="flex items-center space-x-3">
         <div class="w-3 h-3 bg-green-500 rounded-full"></div>
         <div class="text-green-300">
          Đang hoạt động - Gửi cảnh báo tự động
         </div>
        </div>
        <div class="text-gray-400 text-sm mt-2">
         Kênh: #security-alerts | Webhook: Đã cấu hình
        </div>
       </div><!-- Manual IP Block -->
       <div class="bg-white/5 rounded-lg p-6">
        <h5 class="text-white font-semibold mb-4">🚫 Chặn IP thủ công</h5>
        <form onsubmit="manualBlockIP(event)" class="space-y-4">
         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label class="block text-white mb-2">IP Address</label> <input type="text" id="manualBlockIPInput" required placeholder="192.168.1.100" class="w-full px-4 py-3 rounded-lg bg-white/20 text-white placeholder-gray-300 border border-white/30 focus:border-blue-400 focus:outline-none">
          </div>
          <div><label class="block text-white mb-2">Lý do chặn</label> <input type="text" id="manualBlockReason" required placeholder="Hoạt động đáng ngờ" class="w-full px-4 py-3 rounded-lg bg-white/20 text-white placeholder-gray-300 border border-white/30 focus:border-blue-400 focus:outline-none">
          </div>
         </div><button type="submit" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors"> 🚫 Chặn IP </button>
        </form>
       </div>
      </div>
     </div>
    </div>
   </div><!-- Admin Page -->
   <div id="adminPage" class="page hidden">
    <div class="max-w-6xl mx-auto">
     <h2 class="text-3xl font-bold text-white mb-6">👑 Quản trị viên</h2>
     <div class="flex flex-wrap gap-2 mb-6"><button onclick="showAdminTab('users')" class="admin-tab-btn bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">👥 Người dùng</button> <button onclick="showAdminTab('recharges')" class="admin-tab-btn bg-white/20 text-white px-4 py-2 rounded-lg hover:bg-white/30 transition-colors">💵 Nạp tiền</button> <button onclick="showAdminTab('products')" class="admin-tab-btn bg-white/20 text-white px-4 py-2 rounded-lg hover:bg-white/30 transition-colors">🎮 Chờ duyệt</button> <button onclick="showAdminTab('approved')" class="admin-tab-btn bg-white/20 text-white px-4 py-2 rounded-lg hover:bg-white/30 transition-colors">✅ Đã duyệt</button> <button onclick="showAdminTab('quicksell')" class="admin-tab-btn bg-white/20 text-white px-4 py-2 rounded-lg hover:bg-white/30 transition-colors">⚡ Đăng bán nhanh</button> <button onclick="showAdminTab('messages')" class="admin-tab-btn bg-white/20 text-white px-4 py-2 rounded-lg hover:bg-white/30 transition-colors relative"> 💬 Tin nhắn <span id="adminMessageCount" class="absolute -top-1 -right-1 bg-red-500 text-xs rounded-full px-1 hidden">0</span> </button> <button onclick="showAdminTab('withdraw')" class="admin-tab-btn bg-white/20 text-white px-4 py-2 rounded-lg hover:bg-white/30 transition-colors">🏦 Rút tiền</button> <button onclick="showAdminTab('jiro')" class="admin-tab-btn bg-white/20 text-white px-4 py-2 rounded-lg hover:bg-white/30 transition-colors">🔐 File Jiro</button> <button onclick="showAdminTab('security')" class="admin-tab-btn bg-white/20 text-white px-4 py-2 rounded-lg hover:bg-white/30 transition-colors relative"> 🛡️ Bảo mật <span id="securityAlertCount" class="absolute -top-1 -right-1 bg-red-500 text-xs rounded-full px-1 hidden">0</span> </button>
     </div>
     <div id="adminUsers" class="admin-tab bg-white/10 backdrop-blur-md rounded-xl p-6">
      <h3 class="text-xl font-bold text-white mb-4">Danh sách người dùng</h3>
      <div id="usersList" class="space-y-3"><!-- Users list will be loaded here -->
      </div>
     </div>
     <div id="adminRecharges" class="admin-tab hidden bg-white/10 backdrop-blur-md rounded-xl p-6">
      <h3 class="text-xl font-bold text-white mb-4">Yêu cầu nạp tiền</h3>
      <div id="rechargesList" class="space-y-3"><!-- Recharges list will be loaded here -->
      </div>
     </div>
     <div id="adminProducts" class="admin-tab hidden bg-white/10 backdrop-blur-md rounded-xl p-6">
      <h3 class="text-xl font-bold text-white mb-4">🎮 Sản phẩm chờ duyệt</h3>
      <div id="productsList" class="space-y-3"><!-- Products list will be loaded here -->
      </div>
     </div>
     <div id="adminApproved" class="admin-tab hidden bg-white/10 backdrop-blur-md rounded-xl p-6">
      <h3 class="text-xl font-bold text-white mb-4">✅ Sản phẩm đã duyệt</h3>
      <div class="mb-4 flex flex-wrap gap-2"><button onclick="filterApprovedProducts('all')" class="approved-filter-btn bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 transition-colors">Tất cả</button> <button onclick="filterApprovedProducts('available')" class="approved-filter-btn bg-white/20 text-white px-3 py-1 rounded text-sm hover:bg-white/30 transition-colors">Đang bán</button> <button onclick="filterApprovedProducts('sold')" class="approved-filter-btn bg-white/20 text-white px-3 py-1 rounded text-sm hover:bg-white/30 transition-colors">Đã bán</button>
      </div>
      <div id="approvedProductsList" class="space-y-3"><!-- Approved products list will be loaded here -->
      </div>
     </div>
     <div id="adminMessages" class="admin-tab hidden bg-white/10 backdrop-blur-md rounded-xl p-6">
      <h3 class="text-xl font-bold text-white mb-6">💬 Quản lý tin nhắn</h3>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[600px]"><!-- Users List -->
       <div class="bg-white/5 rounded-lg p-4">
        <h4 class="text-white font-semibold mb-4">👥 Danh sách người dùng</h4>
        <div id="chatUsersList" class="space-y-2 overflow-y-auto h-[500px]"><!-- Users will be loaded here -->
        </div>
       </div><!-- Chat Area -->
       <div class="lg:col-span-2 bg-white/5 rounded-lg p-4 flex flex-col">
        <div id="adminChatHeader" class="border-b border-white/20 pb-3 mb-4 hidden">
         <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center">
           👤
          </div>
          <div>
           <div id="selectedUserName" class="text-white font-semibold"></div>
           <div id="selectedUserEmail" class="text-gray-400 text-sm"></div>
          </div>
         </div>
        </div>
        <div id="adminChatPlaceholder" class="flex-1 flex items-center justify-center text-gray-400">
         Chọn một người dùng để bắt đầu trò chuyện
        </div>
        <div id="adminMessagesContainer" class="flex-1 overflow-y-auto space-y-3 mb-4 hidden"><!-- Messages will be loaded here -->
        </div>
        <form id="adminMessageForm" onsubmit="sendAdminMessage(event)" class="hidden">
         <div class="flex space-x-3"><input type="text" id="adminMessageInput" placeholder="Nhập tin nhắn..." required class="flex-1 px-4 py-3 rounded-lg bg-white/20 text-white placeholder-gray-300 border border-white/30 focus:border-blue-400 focus:outline-none"> <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors"> Gửi </button>
         </div>
        </form>
       </div>
      </div>
     </div>
     <div id="adminQuicksell" class="admin-tab hidden bg-white/10 backdrop-blur-md rounded-xl p-6">
      <h3 class="text-xl font-bold text-white mb-6">⚡ Đăng bán nhanh</h3>
      <form id="adminSellForm" onsubmit="handleAdminSell(event)" class="max-w-4xl">
       <div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><!-- Left Column -->
        <div class="space-y-4">
         <div><label class="block text-white mb-2 font-semibold">🎮 Tên game</label> <select id="adminSellGame" required class="w-full px-4 py-3 rounded-lg bg-white/20 text-white border border-white/30 focus:border-blue-400 focus:outline-none"> <option value="">Chọn game</option> <option value="Liên Quân">⚔️ Liên Quân Mobile</option> <option value="PUBG">🔫 PUBG Mobile</option> <option value="Free Fire">🔥 Free Fire</option> <option value="Genshin">✨ Genshin Impact</option> <option value="Minecraft">🧱 Minecraft</option> <option value="Roblox">🎲 Roblox</option> </select>
         </div>
         <div><label class="block text-white mb-2 font-semibold">💰 Giá bán (VNĐ)</label> <input type="number" id="adminSellPrice" required min="1000" step="1000" class="w-full px-4 py-3 rounded-lg bg-white/20 text-white placeholder-gray-300 border border-white/30 focus:border-blue-400 focus:outline-none" placeholder="Nhập giá bán...">
         </div>
         <div><label class="block text-white mb-2 font-semibold">📝 Mô tả tài khoản</label> <textarea id="adminSellDescription" required rows="4" class="w-full px-4 py-3 rounded-lg bg-white/20 text-white placeholder-gray-300 border border-white/30 focus:border-blue-400 focus:outline-none" placeholder="Mô tả chi tiết về tài khoản (rank, skin, vật phẩm...)"></textarea>
         </div>
         <div><label class="block text-white mb-2 font-semibold">🖼️ Hình ảnh tài khoản</label> <input type="file" id="adminSellImage" accept="image/*" class="w-full px-4 py-3 rounded-lg bg-white/20 text-white border border-white/30 focus:border-blue-400 focus:outline-none file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-blue-600 file:text-white file:cursor-pointer hover:file:bg-blue-700">
          <p class="text-gray-400 text-sm mt-1">Chọn hình ảnh minh họa cho tài khoản</p>
         </div>
        </div><!-- Right Column -->
        <div class="space-y-4">
         <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4 mb-4">
          <h4 class="text-yellow-300 font-semibold mb-2">🔐 Thông tin đăng nhập</h4>
          <p class="text-yellow-200 text-sm">Thông tin này sẽ được mã hóa và chỉ hiển thị cho người mua</p>
         </div>
         <div><label class="block text-white mb-2 font-semibold">👤 Tài khoản</label> <input type="text" id="adminSellUsername" required class="w-full px-4 py-3 rounded-lg bg-white/20 text-white placeholder-gray-300 border border-white/30 focus:border-blue-400 focus:outline-none" placeholder="Username/Email đăng nhập">
         </div>
         <div><label class="block text-white mb-2 font-semibold">🔒 Mật khẩu</label> <input type="password" id="adminSellPassword" required class="w-full px-4 py-3 rounded-lg bg-white/20 text-white placeholder-gray-300 border border-white/30 focus:border-blue-400 focus:outline-none" placeholder="Mật khẩu đăng nhập">
         </div>
         <div class="bg-green-500/10 border border-green-500/30 rounded-lg p-4">
          <h4 class="text-green-300 font-semibold mb-2">⚡ Đăng bán nhanh</h4>
          <p class="text-green-200 text-sm mb-3">Sản phẩm sẽ được đăng bán ngay lập tức mà không cần chờ duyệt</p>
          <ul class="text-green-200 text-sm space-y-1">
           <li>✅ Hiển thị ngay trên trang chủ</li>
           <li>✅ Xuất hiện trong danh mục sản phẩm</li>
           <li>✅ Có thể mua ngay lập tức</li>
          </ul>
         </div>
        </div>
       </div>
       <div class="mt-8 flex justify-center"><button type="submit" class="bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 text-white px-8 py-4 rounded-xl font-bold text-lg transition-all transform hover:scale-105 shadow-lg"> ⚡ Đăng bán ngay lập tức </button>
       </div>
      </form>
     </div>
     <div id="adminJiro" class="admin-tab hidden bg-white/10 backdrop-blur-md rounded-xl p-6">
      <h3 class="text-xl font-bold text-white mb-6">🔐 Quản lý File Jiro.txt</h3><!-- File Info -->
      <div class="bg-gradient-to-r from-green-600 to-blue-600 rounded-xl p-6 mb-6">
       <div class="text-center">
        <div class="text-white text-lg mb-2">
         📁 Thông tin file jiro.txt
        </div>
        <div id="jiroFileStats" class="text-white text-sm">
         <div>
          Tổng số tài khoản: <span id="jiroAccountCount" class="font-bold">0</span>
         </div>
         <div>
          Cập nhật lần cuối: <span id="jiroLastUpdate" class="font-bold">Chưa có dữ liệu</span>
         </div>
        </div>
       </div>
      </div><!-- Action Buttons -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"><button onclick="viewJiroFile()" class="bg-blue-600 hover:bg-blue-700 text-white py-4 px-6 rounded-xl font-semibold transition-all transform hover:scale-105 shadow-lg"> 👁️ Xem nội dung file </button> <button onclick="downloadJiroFile()" class="bg-green-600 hover:bg-green-700 text-white py-4 px-6 rounded-xl font-semibold transition-all transform hover:scale-105 shadow-lg"> 📥 Tải xuống file </button> <button onclick="clearJiroFile()" class="bg-red-600 hover:bg-red-700 text-white py-4 px-6 rounded-xl font-semibold transition-all transform hover:scale-105 shadow-lg"> 🗑️ Xóa toàn bộ </button>
      </div><!-- File Description -->
      <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-6">
       <div class="flex items-start space-x-3">
        <div class="text-yellow-400 text-2xl">
         ℹ️
        </div>
        <div>
         <div class="text-yellow-300 font-semibold mb-3">
          Về file jiro.txt:
         </div>
         <ul class="text-yellow-200 text-sm space-y-2">
          <li>• <strong>Mục đích:</strong> Lưu trữ mật khẩu băm SHA256 của tất cả tài khoản đã đăng ký</li>
          <li>• <strong>Bảo mật:</strong> Mật khẩu được băm không thể đảo ngược, đảm bảo an toàn tuyệt đối</li>
          <li>• <strong>Tự động:</strong> Mỗi khi có tài khoản mới đăng ký, mật khẩu sẽ tự động được lưu vào file</li>
          <li>• <strong>Định dạng:</strong> Email, Hash SHA256, thời gian tạo, nguồn dữ liệu</li>
          <li>• <strong>Quyền truy cập:</strong> Chỉ admin mới có thể xem và tải file này</li>
         </ul>
        </div>
       </div>
      </div><!-- Recent Entries -->
      <div class="mt-6">
       <h4 class="text-lg font-bold text-white mb-4">📋 Các mục gần đây</h4>
       <div id="recentJiroEntries" class="space-y-3"><!-- Recent entries will be loaded here -->
       </div>
      </div>
     </div>
     <div id="adminWithdraw" class="admin-tab hidden bg-white/10 backdrop-blur-md rounded-xl p-6">
      <h3 class="text-xl font-bold text-white mb-6">🏦 Rút tiền về ngân hàng</h3><!-- Admin Balance Display -->
      <div class="bg-gradient-to-r from-green-600 to-blue-600 rounded-xl p-6 mb-6">
       <div class="text-center">
        <div class="text-white text-lg mb-2">
         💰 Số dư hiện tại
        </div>
        <div id="adminCurrentBalance" class="text-white text-3xl font-bold mb-2">
         0 VNĐ
        </div>
        <div class="text-green-200 text-sm">
         Có thể rút toàn bộ số dư
        </div>
       </div>
      </div><!-- Withdrawal Form -->
      <form id="withdrawForm" onsubmit="handleWithdraw(event)" class="max-w-2xl mx-auto">
       <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div><label class="block text-white mb-2 font-semibold">💵 Số tiền rút (VNĐ)</label> <input type="number" id="withdrawAmount" required min="50000" step="1000" class="w-full px-4 py-3 rounded-lg bg-white/20 text-white placeholder-gray-300 border border-white/30 focus:border-blue-400 focus:outline-none" placeholder="Nhập số tiền muốn rút...">
         <p class="text-gray-400 text-sm mt-1">Tối thiểu: 50,000 VNĐ</p>
        </div>
        <div><label class="block text-white mb-2 font-semibold">🏦 Ngân hàng</label> <select id="withdrawBank" required class="w-full px-4 py-3 rounded-lg bg-white/20 text-white border border-white/30 focus:border-blue-400 focus:outline-none"> <option value="">Chọn ngân hàng</option> <option value="vietcombank">Vietcombank</option> <option value="techcombank">Techcombank</option> <option value="bidv">BIDV</option> <option value="vietinbank">VietinBank</option> <option value="agribank">Agribank</option> <option value="mbbank">MB Bank</option> <option value="acb">ACB</option> <option value="tpbank">TPBank</option> <option value="sacombank">Sacombank</option> <option value="vpbank">VPBank</option> </select>
        </div>
       </div>
       <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div><label class="block text-white mb-2 font-semibold">🔢 Số tài khoản</label> <input type="text" id="withdrawAccountNumber" required class="w-full px-4 py-3 rounded-lg bg-white/20 text-white placeholder-gray-300 border border-white/30 focus:border-blue-400 focus:outline-none" placeholder="Nhập số tài khoản...">
        </div>
        <div><label class="block text-white mb-2 font-semibold">👤 Tên chủ tài khoản</label> <input type="text" id="withdrawAccountName" required class="w-full px-4 py-3 rounded-lg bg-white/20 text-white placeholder-gray-300 border border-white/30 focus:border-blue-400 focus:outline-none" placeholder="Tên chủ tài khoản...">
        </div>
       </div>
       <div class="mb-6"><label class="block text-white mb-2 font-semibold">📝 Ghi chú (tùy chọn)</label> <textarea id="withdrawNote" rows="3" class="w-full px-4 py-3 rounded-lg bg-white/20 text-white placeholder-gray-300 border border-white/30 focus:border-blue-400 focus:outline-none" placeholder="Ghi chú thêm về giao dịch..."></textarea>
       </div><!-- Quick Amount Buttons -->
       <div class="mb-6">
        <div class="text-white mb-3 font-semibold">
         ⚡ Chọn nhanh:
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3"><button type="button" onclick="setWithdrawAmount(1000000)" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg text-sm transition-colors"> 1,000,000 VNĐ </button> <button type="button" onclick="setWithdrawAmount(5000000)" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg text-sm transition-colors"> 5,000,000 VNĐ </button> <button type="button" onclick="setWithdrawAmount(10000000)" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg text-sm transition-colors"> 10,000,000 VNĐ </button> <button type="button" onclick="setWithdrawAllAmount()" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg text-sm transition-colors"> Rút hết </button>
        </div>
       </div><!-- Warning Notice -->
       <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4 mb-6">
        <div class="flex items-start space-x-3">
         <div class="text-yellow-400 text-xl">
          ⚠️
         </div>
         <div>
          <div class="text-yellow-300 font-semibold mb-2">
           Lưu ý quan trọng:
          </div>
          <ul class="text-yellow-200 text-sm space-y-1">
           <li>• Giao dịch rút tiền sẽ được xử lý trong 1-3 ngày làm việc</li>
           <li>• Vui lòng kiểm tra kỹ thông tin tài khoản ngân hàng</li>
           <li>• Phí rút tiền: 0% (miễn phí hoàn toàn)</li>
           <li>• Không thể hủy giao dịch sau khi xác nhận</li>
          </ul>
         </div>
        </div>
       </div>
       <div class="flex justify-center"><button type="submit" class="bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 text-white px-8 py-4 rounded-xl font-bold text-lg transition-all transform hover:scale-105 shadow-lg"> 🏦 Tạo lệnh rút tiền </button>
       </div>
      </form><!-- Withdrawal History -->
      <div class="mt-8">
       <h4 class="text-xl font-bold text-white mb-4">📋 Lịch sử rút tiền</h4>
       <div id="withdrawalHistory" class="space-y-3"><!-- Withdrawal history will be loaded here -->
       </div>
      </div>
     </div>
     <div id="adminSecurity" class="admin-tab hidden bg-white/10 backdrop-blur-md rounded-2xl p-6">
      <h3 class="text-xl font-bold text-white mb-6">🛡️ Quản lý bảo mật</h3><!-- Security Overview -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
       <div class="bg-gradient-to-r from-red-600 to-red-700 rounded-xl p-4 text-center">
        <div class="text-white text-2xl font-bold" id="blockedIPCount">
         0
        </div>
        <div class="text-red-100 text-sm">
         IP bị chặn
        </div>
       </div>
       <div class="bg-gradient-to-r from-yellow-600 to-yellow-700 rounded-xl p-4 text-center">
        <div class="text-white text-2xl font-bold" id="securityAlertCountDisplay">
         0
        </div>
        <div class="text-yellow-100 text-sm">
         Cảnh báo chưa xử lý
        </div>
       </div>
       <div class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-xl p-4 text-center">
        <div class="text-white text-2xl font-bold" id="totalFailedAttempts">
         0
        </div>
        <div class="text-blue-100 text-sm">
         Lần thử thất bại hôm nay
        </div>
       </div>
      </div><!-- Security Tabs -->
      <div class="flex flex-wrap gap-2 mb-6"><button onclick="showSecurityTab('alerts')" class="security-tab-btn bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">🚨 Cảnh báo</button> <button onclick="showSecurityTab('blocked')" class="security-tab-btn bg-white/20 text-white px-4 py-2 rounded-lg hover:bg-white/30 transition-colors">🔒 IP bị chặn</button> <button onclick="showSecurityTab('logs')" class="security-tab-btn bg-white/20 text-white px-4 py-2 rounded-lg hover:bg-white/30 transition-colors">📋 Nhật ký</button> <button onclick="showSecurityTab('settings')" class="security-tab-btn bg-white/20 text-white px-4 py-2 rounded-lg hover:bg-white/30 transition-colors">⚙️ Cài đặt</button>
      </div><!-- Security Alerts Tab -->
      <div id="securityAlertsTab" class="security-tab">
       <h4 class="text-lg font-bold text-white mb-4">🚨 Cảnh báo bảo mật</h4>
       <div id="securityAlertsList" class="space-y-3"><!-- Security alerts will be loaded here -->
       </div>
      </div><!-- Blocked IPs Tab -->
      <div id="securityBlockedTab" class="security-tab hidden">
       <h4 class="text-lg font-bold text-white mb-4">🔒 Danh sách IP bị chặn</h4>
       <div id="blockedIPsList" class="space-y-3"><!-- Blocked IPs will be loaded here -->
       </div>
      </div><!-- Security Logs Tab -->
      <div id="securityLogsTab" class="security-tab hidden">
       <h4 class="text-lg font-bold text-white mb-4">📋 Nhật ký bảo mật</h4>
       <div class="mb-4 flex flex-wrap gap-2"><button onclick="filterSecurityLogs('all')" class="log-filter-btn bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 transition-colors">Tất cả</button> <button onclick="filterSecurityLogs('login')" class="log-filter-btn bg-white/20 text-white px-3 py-1 rounded text-sm hover:bg-white/30 transition-colors">Đăng nhập</button> <button onclick="filterSecurityLogs('failed_login')" class="log-filter-btn bg-white/20 text-white px-3 py-1 rounded text-sm hover:bg-white/30 transition-colors">Thất bại</button> <button onclick="filterSecurityLogs('ip_blocked')" class="log-filter-btn bg-white/20 text-white px-3 py-1 rounded text-sm hover:bg-white/30 transition-colors">Chặn IP</button> <button onclick="filterSecurityLogs('purchase')" class="log-filter-btn bg-white/20 text-white px-3 py-1 rounded text-sm hover:bg-white/30 transition-colors">Mua hàng</button>
       </div>
       <div id="securityLogsList" class="space-y-3 max-h-[500px] overflow-y-auto"><!-- Security logs will be loaded here -->
       </div>
      </div><!-- Security Settings Tab -->
      <div id="securitySettingsTab" class="security-tab hidden">
       <h4 class="text-lg font-bold text-white mb-6">⚙️ Cài đặt bảo mật</h4><!-- Current Settings -->
       <div class="bg-white/5 rounded-lg p-6 mb-6">
        <h5 class="text-white font-semibold mb-4">📊 Cấu hình hiện tại</h5>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
         <div class="bg-white/5 rounded-lg p-3">
          <div class="text-gray-300">
           Số lần thử tối đa:
          </div>
          <div class="text-white font-bold text-lg">
           ${THROTTLE_CONFIG.maxAttempts} lần
          </div>
         </div>
         <div class="bg-white/5 rounded-lg p-3">
          <div class="text-gray-300">
           Khung thời gian:
          </div>
          <div class="text-white font-bold text-lg">
           ${THROTTLE_CONFIG.timeWindow / 60000} phút
          </div>
         </div>
         <div class="bg-white/5 rounded-lg p-3">
          <div class="text-gray-300">
           Thời gian chặn:
          </div>
          <div class="text-white font-bold text-lg">
           ${THROTTLE_CONFIG.blockDuration / 60000} phút
          </div>
         </div>
        </div>
       </div><!-- Slack Integration Status -->
       <div class="bg-white/5 rounded-lg p-6 mb-6">
        <h5 class="text-white font-semibold mb-4">📱 Tích hợp Slack</h5>
        <div class="flex items-center space-x-3">
         <div class="w-3 h-3 bg-green-500 rounded-full"></div>
         <div class="text-green-300">
          Đang hoạt động - Gửi cảnh báo tự động
         </div>
        </div>
        <div class="text-gray-400 text-sm mt-2">
         Kênh: #security-alerts | Webhook: Đã cấu hình
        </div>
       </div><!-- Manual IP Block -->
       <div class="bg-white/5 rounded-lg p-6">
        <h5 class="text-white font-semibold mb-4">🚫 Chặn IP thủ công</h5>
        <form onsubmit="manualBlockIP(event)" class="space-y-4">
         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label class="block text-white mb-2">IP Address</label> <input type="text" id="manualBlockIPInput" required placeholder="192.168.1.100" class="w-full px-4 py-3 rounded-lg bg-white/20 text-white placeholder-gray-300 border border-white/30 focus:border-blue-400 focus:outline-none">
          </div>
          <div><label class="block text-white mb-2">Lý do chặn</label> <input type="text" id="manualBlockReason" required placeholder="Hoạt động đáng ngờ" class="w-full px-4 py-3 rounded-lg bg-white/20 text-white placeholder-gray-300 border border-white/30 focus:border-blue-400 focus:outline-none">
          </div>
         </div><button type="submit" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors"> 🚫 Chặn IP </button>
        </form>
       </div>
      </div>
     </div>
    </div>
   </div><!-- Recharge Modal -->
   <div id="rechargeModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50">
    <div class="bg-white/10 backdrop-blur-md rounded-2xl p-8 max-w-md w-full mx-4">
     <h3 class="text-2xl font-bold text-white mb-6 text-center">💰 Nạp tiền</h3>
     <form id="rechargeForm" onsubmit="handleRecharge(event)">
      <div class="mb-4"><label class="block text-white mb-2">Số tiền (VNĐ)</label> <select id="rechargeAmount" required class="w-full px-4 py-3 rounded-lg bg-white/20 text-white border border-white/30 focus:border-blue-400 focus:outline-none"> <option value="">Chọn mệnh giá</option> <option value="50000">50,000 VNĐ</option> <option value="100000">100,000 VNĐ</option> <option value="200000">200,000 VNĐ</option> <option value="500000">500,000 VNĐ</option> <option value="1000000">1,000,000 VNĐ</option> </select>
      </div>
      <div class="mb-4"><label class="block text-white mb-2">Phương thức</label> <select id="rechargeMethod" required class="w-full px-4 py-3 rounded-lg bg-white/20 text-white border border-white/30 focus:border-blue-400 focus:outline-none"> <option value="">Chọn phương thức</option> <option value="momo">Ví MoMo</option> <option value="bank">Chuyển khoản ngân hàng</option> <option value="card">Thẻ game</option> </select>
      </div>
      <div class="mb-6"><label class="block text-white mb-2">Ghi chú</label> <textarea id="rechargeNote" rows="3" class="w-full px-4 py-3 rounded-lg bg-white/20 text-white placeholder-gray-300 border border-white/30 focus:border-blue-400 focus:outline-none" placeholder="Ghi chú thêm (tùy chọn)"></textarea>
      </div>
      <div class="flex space-x-3"><button type="button" onclick="hideRechargeForm()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-lg font-semibold transition-colors"> Hủy </button> <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-semibold transition-colors"> Gửi yêu cầu </button>
      </div>
     </form>
    </div>
   </div><!-- Change Password Modal -->
   <div id="changePasswordModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50">
    <div class="bg-white/10 backdrop-blur-md rounded-2xl p-8 max-w-md w-full mx-4">
     <h3 class="text-2xl font-bold text-white mb-6 text-center">🔒 Đổi mật khẩu</h3>
     <form id="changePasswordForm" onsubmit="handleChangePassword(event)">
      <div class="mb-4"><label class="block text-white mb-2">Mật khẩu cũ</label> <input type="password" id="oldPassword" required class="w-full px-4 py-3 rounded-lg bg-white/20 text-white placeholder-gray-300 border border-white/30 focus:border-blue-400 focus:outline-none">
      </div>
      <div class="mb-4"><label class="block text-white mb-2">Mật khẩu mới</label> <input type="password" id="newPassword" required class="w-full px-4 py-3 rounded-lg bg-white/20 text-white placeholder-gray-300 border border-white/30 focus:border-blue-400 focus:outline-none">
      </div>
      <div class="mb-6"><label class="block text-white mb-2">Xác nhận mật khẩu mới</label> <input type="password" id="confirmNewPassword" required class="w-full px-4 py-3 rounded-lg bg-white/20 text-white placeholder-gray-300 border border-white/30 focus:border-blue-400 focus:outline-none">
      </div>
      <div class="flex space-x-3"><button type="button" onclick="hideChangePasswordForm()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-lg font-semibold transition-colors"> Hủy </button> <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold transition-colors"> Đổi mật khẩu </button>
      </div>
     </form>
    </div>
   </div>
  </div><!-- Footer -->
  <footer class="bg-black/30 backdrop-blur-md border-t border-white/10 mt-16">
   <div class="max-w-7xl mx-auto px-4 py-12">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
     <div>
      <h3 class="text-xl font-bold text-white mb-4">🎮 GameShop</h3>
      <p class="text-gray-300">Nền tảng mua bán tài khoản game uy tín và an toàn nhất Việt Nam.</p>
     </div>
     <div>
      <h4 class="font-semibold text-white mb-4">Dịch vụ</h4>
      <ul class="space-y-2 text-gray-300">
       <li><a href="#" class="hover:text-white transition-colors">Mua tài khoản</a></li>
       <li><a href="#" class="hover:text-white transition-colors">Bán tài khoản</a></li>
       <li><a href="#" class="hover:text-white transition-colors">Nạp tiền</a></li>
       <li><a href="#" class="hover:text-white transition-colors">Hỗ trợ</a></li>
      </ul>
     </div>
     <div>
      <h4 class="font-semibold text-white mb-4">Liên hệ</h4>
      <ul class="space-y-2 text-gray-300">
       <li>📧 support@gameshop.vn</li>
       <li>📞 0123 456 789</li>
       <li>📍 Hà Nội, Việt Nam</li>
      </ul>
     </div>
     <div>
      <h4 class="font-semibold text-white mb-4">Mạng xã hội</h4>
      <div class="flex space-x-4"><a href="#" class="text-2xl hover:text-blue-400 transition-colors">📘</a> <a href="#" class="text-2xl hover:text-pink-400 transition-colors">📷</a> <a href="#" class="text-2xl hover:text-blue-300 transition-colors">🐦</a> <a href="#" class="text-2xl hover:text-red-400 transition-colors">📺</a>
      </div>
     </div>
    </div>
    <div class="border-t border-white/10 mt-8 pt-8 text-center text-gray-300">
     <p>© 2024 GameShop. Tất cả quyền được bảo lưu.</p>
    </div>
   </div>
  </footer>
  <script>
        // Global variables
        let currentUser = null;
        let cart = [];
        let products = [];
        let users = [];
        let recharges = [];
        let messages = [];
        let withdrawals = [];
        let selectedChatUser = null;
        let otpCode = '';
        let otpTimer = null;
        let pendingUser = null;
        let forgotOtpCode = '';
        let forgotOtpTimer = null;
        let forgotPasswordUser = null;

        // IP Throttling System
        let ipThrottleData = JSON.parse(localStorage.getItem('gameShopIPThrottle') || '{}');
        let blockedIPs = JSON.parse(localStorage.getItem('gameShopBlockedIPs') || '{}');
        let securityAlerts = JSON.parse(localStorage.getItem('gameShopSecurityAlerts') || '[]');
        let blockCountdownTimer = null;
        
        // Throttling configuration
        const THROTTLE_CONFIG = {
            maxAttempts: 5,
            timeWindow: 10 * 60 * 1000, // 10 minutes
            blockDuration: 5 * 60 * 1000 // 5 minutes
        };

        // Password strength validation
        function validatePasswordStrength(password) {
            const requirements = {
                length: password.length >= 8,
                uppercase: /[A-Z]/.test(password),
                number: /[0-9]/.test(password),
                special: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)
            };
            
            const isValid = Object.values(requirements).every(req => req);
            
            let message = '';
            if (!requirements.length) message = 'Mật khẩu phải có ít nhất 8 ký tự';
            else if (!requirements.uppercase) message = 'Mật khẩu phải có ít nhất 1 chữ hoa';
            else if (!requirements.number) message = 'Mật khẩu phải có ít nhất 1 số';
            else if (!requirements.special) message = 'Mật khẩu phải có ít nhất 1 ký tự đặc biệt';
            
            return { isValid, requirements, message };
        }

        function updatePasswordRequirements(password) {
            const validation = validatePasswordStrength(password);
            
            // Update requirement indicators
            document.getElementById('req-length').className = validation.requirements.length ? 'text-green-400' : 'text-red-400';
            document.getElementById('req-uppercase').className = validation.requirements.uppercase ? 'text-green-400' : 'text-red-400';
            document.getElementById('req-number').className = validation.requirements.number ? 'text-green-400' : 'text-red-400';
            document.getElementById('req-special').className = validation.requirements.special ? 'text-green-400' : 'text-red-400';
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            
            // Add password strength checker
            const passwordInput = document.getElementById('registerPassword');
            if (passwordInput) {
                passwordInput.addEventListener('input', function() {
                    updatePasswordRequirements(this.value);
                });
            }
        });

        function initializeApp() {
            loadData();
            createDefaultAdmin();
            updateUI();
            loadFeaturedProducts();
            loadProducts();
        }

        function loadData() {
            // Load users
            const savedUsers = localStorage.getItem('gameShopUsers');
            if (savedUsers) {
                users = JSON.parse(savedUsers);
            }

            // Load products
            const savedProducts = localStorage.getItem('gameShopProducts');
            if (savedProducts) {
                products = JSON.parse(savedProducts);
            } else {
                // Start with empty products array
                products = [];
                saveProducts();
            }

            // Load recharges
            const savedRecharges = localStorage.getItem('gameShopRecharges');
            if (savedRecharges) {
                recharges = JSON.parse(savedRecharges);
            }

            // Load current user
            const savedCurrentUser = localStorage.getItem('gameShopCurrentUser');
            if (savedCurrentUser) {
                currentUser = JSON.parse(savedCurrentUser);
            }

            // Load cart
            const savedCart = localStorage.getItem('gameShopCart');
            if (savedCart) {
                cart = JSON.parse(savedCart);
            }

            // Load messages
            const savedMessages = localStorage.getItem('gameShopMessages');
            if (savedMessages) {
                messages = JSON.parse(savedMessages);
            }

            // Load withdrawals
            const savedWithdrawals = localStorage.getItem('gameShopWithdrawals');
            if (savedWithdrawals) {
                withdrawals = JSON.parse(savedWithdrawals);
            }
        }

        function createDefaultAdmin() {
            const adminExists = users.find(user => user.email === 'admin@gameshop.vn');
            if (!adminExists) {
                const adminUser = {
                    id: Date.now(),
                    name: 'Quản trị viên',
                    email: 'admin@gameshop.vn',
                    password: CryptoJS.SHA256('admin123').toString(),
                    role: 'admin',
                    balance: 0,
                    createdAt: new Date().toISOString()
                };
                users.push(adminUser);
                saveUsers();
            }
        }

        function saveUsers() {
            localStorage.setItem('gameShopUsers', JSON.stringify(users));
        }

        function saveProducts() {
            localStorage.setItem('gameShopProducts', JSON.stringify(products));
        }

        function saveRecharges() {
            localStorage.setItem('gameShopRecharges', JSON.stringify(recharges));
        }

        function saveCurrentUser() {
            localStorage.setItem('gameShopCurrentUser', JSON.stringify(currentUser));
        }

        function saveCart() {
            localStorage.setItem('gameShopCart', JSON.stringify(cart));
        }

        function saveMessages() {
            localStorage.setItem('gameShopMessages', JSON.stringify(messages));
        }

        function saveWithdrawals() {
            localStorage.setItem('gameShopWithdrawals', JSON.stringify(withdrawals));
        }

        // IP Throttling Functions
        function saveIPThrottleData() {
            localStorage.setItem('gameShopIPThrottle', JSON.stringify(ipThrottleData));
            localStorage.setItem('gameShopBlockedIPs', JSON.stringify(blockedIPs));
            localStorage.setItem('gameShopSecurityAlerts', JSON.stringify(securityAlerts));
        }

        function getCurrentIP() {
            // In a real application, this would be the actual client IP
            // For demo purposes, we'll use a simulated IP based on browser fingerprint
            return 'demo_' + (localStorage.getItem('demoIP') || generateDemoIP());
        }

        function generateDemoIP() {
            const ip = `192.168.1.${Math.floor(Math.random() * 254) + 1}`;
            localStorage.setItem('demoIP', ip);
            return ip;
        }

        function recordFailedLogin(email) {
            const ip = getCurrentIP();
            const now = Date.now();
            
            // Initialize IP data if not exists
            if (!ipThrottleData[ip]) {
                ipThrottleData[ip] = {
                    attempts: [],
                    totalAttempts: 0
                };
            }
            
            // Add current attempt
            ipThrottleData[ip].attempts.push(now);
            ipThrottleData[ip].totalAttempts++;
            
            // Clean old attempts (outside time window)
            ipThrottleData[ip].attempts = ipThrottleData[ip].attempts.filter(
                timestamp => (now - timestamp) <= THROTTLE_CONFIG.timeWindow
            );
            
            const recentAttempts = ipThrottleData[ip].attempts.length;
            
            // Check if should block IP
            if (recentAttempts >= THROTTLE_CONFIG.maxAttempts) {
                blockIP(ip, recentAttempts, email);
                return true; // IP is now blocked
            }
            
            saveIPThrottleData();
            return false; // IP not blocked yet
        }

        function blockIP(ip, attemptCount, lastAttemptedEmail) {
            const now = Date.now();
            
            // Block the IP
            blockedIPs[ip] = {
                blockedAt: now,
                reason: 'Too many failed login attempts',
                attemptCount: attemptCount,
                lastAttemptedEmail: lastAttemptedEmail,
                unblocked: false
            };
            
            // Create security alert
            const alert = {
                id: Date.now(),
                type: 'IP_BLOCKED',
                ip: ip,
                reason: `IP blocked due to ${attemptCount} failed login attempts in ${THROTTLE_CONFIG.timeWindow / 60000} minutes`,
                attemptCount: attemptCount,
                lastAttemptedEmail: lastAttemptedEmail,
                timestamp: new Date().toISOString(),
                acknowledged: false
            };
            
            securityAlerts.push(alert);
            
            // Log security event
            logSecurityEvent('ip_blocked', {
                ip: ip,
                attemptCount: attemptCount,
                lastAttemptedEmail: lastAttemptedEmail,
                blocked: true,
                timestamp: new Date().toISOString()
            });
            
            // Send Slack alert (simulated)
            sendSlackAlert(ip, attemptCount, lastAttemptedEmail);
            
            saveIPThrottleData();
            
            console.log(`🚨 SECURITY ALERT: IP ${ip} has been blocked due to ${attemptCount} failed login attempts`);
        }

        function isIPBlocked(ip) {
            if (!blockedIPs[ip] || blockedIPs[ip].unblocked) {
                return false;
            }
            
            const now = Date.now();
            const blockTime = blockedIPs[ip].blockedAt;
            const timeSinceBlock = now - blockTime;
            
            // Check if block has expired
            if (timeSinceBlock >= THROTTLE_CONFIG.blockDuration) {
                // Auto-unblock
                blockedIPs[ip].unblocked = true;
                blockedIPs[ip].autoUnblockedAt = now;
                saveIPThrottleData();
                
                logSecurityEvent('ip_unblocked', {
                    ip: ip,
                    reason: 'Auto-unblocked after timeout',
                    timestamp: new Date().toISOString()
                });
                
                return false;
            }
            
            return true;
        }

        function getIPStatus(ip) {
            if (!blockedIPs[ip] || blockedIPs[ip].unblocked) {
                return { blocked: false };
            }
            
            const now = Date.now();
            const blockTime = blockedIPs[ip].blockedAt;
            const timeSinceBlock = now - blockTime;
            const timeUntilUnblock = THROTTLE_CONFIG.blockDuration - timeSinceBlock;
            
            if (timeUntilUnblock <= 0) {
                return { blocked: false };
            }
            
            return {
                blocked: true,
                timeUntilUnblock: timeUntilUnblock,
                minutesLeft: Math.ceil(timeUntilUnblock / 60000)
            };
        }

        function unblockIP(ip) {
            if (blockedIPs[ip] && !blockedIPs[ip].unblocked) {
                blockedIPs[ip].unblocked = true;
                blockedIPs[ip].unblockedAt = Date.now();
                blockedIPs[ip].unblockedBy = currentUser ? currentUser.email : 'system';
                
                saveIPThrottleData();
                
                logSecurityEvent('ip_unblocked', {
                    ip: ip,
                    unblockedBy: currentUser ? currentUser.email : 'system',
                    timestamp: new Date().toISOString()
                });
                
                return true;
            }
            return false;
        }

        function cleanExpiredThrottleData() {
            const now = Date.now();
            
            // Clean old attempt records
            Object.keys(ipThrottleData).forEach(ip => {
                if (ipThrottleData[ip].attempts) {
                    ipThrottleData[ip].attempts = ipThrottleData[ip].attempts.filter(
                        timestamp => (now - timestamp) <= THROTTLE_CONFIG.timeWindow
                    );
                    
                    // Remove IP data if no recent attempts
                    if (ipThrottleData[ip].attempts.length === 0) {
                        delete ipThrottleData[ip];
                    }
                }
            });
            
            saveIPThrottleData();
        }

        function sendSlackAlert(ip, attemptCount, lastAttemptedEmail) {
            // Simulate Slack webhook call
            const slackMessage = {
                text: `🚨 SECURITY ALERT: IP blocked due to failed logins`,
                attachments: [{
                    color: 'danger',
                    fields: [
                        { title: 'IP Address', value: ip, short: true },
                        { title: 'Failed Attempts', value: attemptCount.toString(), short: true },
                        { title: 'Time Window', value: '10 minutes', short: true },
                        { title: 'Block Duration', value: '5 minutes', short: true },
                        { title: 'Last Email Attempted', value: lastAttemptedEmail || 'N/A', short: false },
                        { title: 'Timestamp', value: new Date().toLocaleString('vi-VN'), short: false }
                    ]
                }]
            };
            
            // In a real application, this would be an actual HTTP request to Slack
            console.log('📱 Slack Alert Sent:', slackMessage);
            
            // Show simulated Slack notification in UI
            showToast(`📱 Slack Alert: IP ${ip} blocked (${attemptCount} failed attempts)`, 'error');
        }

        function showIPBlockedWarning(ip, status) {
            // Hide login form
            document.getElementById('loginPage').innerHTML = `
                <div class="max-w-md mx-auto bg-red-900/20 backdrop-blur-md rounded-2xl p-8 border-2 border-red-500/50">
                    <div class="text-center mb-6">
                        <div class="text-6xl mb-4">🚨</div>
                        <h2 class="text-3xl font-bold text-red-300 mb-2">IP bị chặn tạm thời</h2>
                        <p class="text-red-200">Quá nhiều lần đăng nhập thất bại</p>
                    </div>
                    
                    <div class="bg-red-800/30 border border-red-500/50 rounded-lg p-4 mb-6">
                        <div class="text-red-200 text-sm space-y-2">
                            <div><strong>IP của bạn:</strong> <span class="font-mono">${ip}</span></div>
                            <div><strong>Lý do:</strong> Đăng nhập sai quá ${THROTTLE_CONFIG.maxAttempts} lần trong ${THROTTLE_CONFIG.timeWindow / 60000} phút</div>
                            <div><strong>Thời gian chặn:</strong> ${THROTTLE_CONFIG.blockDuration / 60000} phút</div>
                        </div>
                    </div>
                    
                    <div class="text-center mb-6">
                        <div class="text-red-300 text-lg font-bold mb-2">Thời gian còn lại:</div>
                        <div id="blockCountdown" class="text-4xl font-mono text-red-100 bg-red-800/50 rounded-lg py-4">
                            ${Math.ceil(status.timeUntilUnblock / 1000 / 60)}:00
                        </div>
                    </div>
                    
                    <div class="bg-yellow-800/30 border border-yellow-500/50 rounded-lg p-4 mb-6">
                        <div class="text-yellow-200 text-sm">
                            <div class="font-semibold mb-2">💡 Lời khuyên:</div>
                            <ul class="space-y-1 text-xs">
                                <li>• Kiểm tra lại email và mật khẩu</li>
                                <li>• Sử dụng tính năng "Quên mật khẩu" nếu cần</li>
                                <li>• Đợi hết thời gian chặn để thử lại</li>
                                <li>• Liên hệ hỗ trợ nếu vấn đề vẫn tiếp diễn</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="showPage('home')" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-lg font-semibold transition-colors">
                            🏠 Về trang chủ
                        </button>
                        <button onclick="showPage('forgot')" class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white py-3 rounded-lg font-semibold transition-colors">
                            🔑 Quên mật khẩu
                        </button>
                    </div>
                </div>
            `;
            
            startBlockCountdown(status.timeUntilUnblock);
        }

        function startBlockCountdown(timeLeft) {
            const countdownElement = document.getElementById('blockCountdown');
            if (!countdownElement) return;
            
            // Clear existing timer
            if (blockCountdownTimer) {
                clearInterval(blockCountdownTimer);
            }
            
            blockCountdownTimer = setInterval(() => {
                timeLeft -= 1000;
                
                if (timeLeft <= 0) {
                    clearInterval(blockCountdownTimer);
                    blockCountdownTimer = null;
                    
                    // Show success message and restore login form
                    showToast('🎉 Đã hết thời gian chặn! Bạn có thể đăng nhập lại.', 'success');
                    
                    setTimeout(() => {
                        showPage('login');
                        // Restore original login form
                        location.reload();
                    }, 2000);
                    
                    return;
                }
                
                const minutes = Math.floor(timeLeft / 60000);
                const seconds = Math.floor((timeLeft % 60000) / 1000);
                countdownElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // Hàm lưu mật khẩu băm vào file jiro.txt
        function savePasswordToJiroFile(email, hashedPassword, source = 'GameShop Registration') {
            try {
                // Tạo dữ liệu để lưu vào file jiro.txt
                const timestamp = new Date().toISOString();
                const jiroData = {
                    email: email,
                    passwordHash: hashedPassword,
                    hashType: 'SHA256',
                    createdAt: timestamp,
                    source: source
                };
                
                // Lấy dữ liệu hiện tại từ localStorage (mô phỏng file jiro.txt)
                let jiroFileContent = JSON.parse(localStorage.getItem('jiroFileContent') || '[]');
                
                // Thêm dữ liệu mới
                jiroFileContent.push(jiroData);
                
                // Lưu lại vào localStorage
                localStorage.setItem('jiroFileContent', JSON.stringify(jiroFileContent));
                
                // Tạo nội dung file text để có thể download
                const textContent = jiroFileContent.map(item => 
                    `Email: ${item.email}\n` +
                    `Password Hash (${item.hashType}): ${item.passwordHash}\n` +
                    `Created: ${item.createdAt}\n` +
                    `Source: ${item.source}\n` +
                    `${'='.repeat(80)}\n`
                ).join('\n');
                
                // Lưu nội dung text
                localStorage.setItem('jiroFileText', textContent);
                
                console.log(`✅ Đã lưu mật khẩu băm của ${email} vào file jiro.txt`);
                
                // Hiển thị thông báo cho admin nếu đang đăng nhập
                if (currentUser && currentUser.role === 'admin') {
                    showToast(`🔐 Đã lưu mật khẩu băm của ${email} vào jiro.txt`, 'success');
                }
                
            } catch (error) {
                console.error('Lỗi khi lưu vào file jiro.txt:', error);
            }
        }

        // Hàm tải file jiro.txt (chỉ admin mới có thể sử dụng)
        function downloadJiroFile() {
            if (!currentUser || currentUser.role !== 'admin') {
                showToast('Chỉ admin mới có thể tải file này', 'error');
                return;
            }
            
            const textContent = localStorage.getItem('jiroFileText') || 'File jiro.txt trống';
            const blob = new Blob([textContent], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'jiro.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showToast('✅ Đã tải file jiro.txt thành công', 'success');
        }

        // Hàm xem nội dung file jiro.txt (chỉ admin)
        function viewJiroFile() {
            if (!currentUser || currentUser.role !== 'admin') {
                showToast('Chỉ admin mới có thể xem file này', 'error');
                return;
            }
            
            const jiroContent = JSON.parse(localStorage.getItem('jiroFileContent') || '[]');
            
            if (jiroContent.length === 0) {
                showToast('File jiro.txt đang trống', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white/10 backdrop-blur-md rounded-2xl p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-white">🔐 Nội dung file jiro.txt</h3>
                        <div class="flex space-x-2">
                            <button onclick="downloadJiroFile()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                                📥 Tải xuống
                            </button>
                            <button onclick="this.parentElement.parentElement.parentElement.parentElement.remove()" class="text-gray-400 hover:text-white text-2xl">×</button>
                        </div>
                    </div>
                    
                    <div class="bg-black/30 rounded-lg p-4 mb-4">
                        <div class="text-yellow-300 text-sm mb-2">📊 Thống kê:</div>
                        <div class="text-white text-sm">
                            • Tổng số tài khoản: ${jiroContent.length}<br>
                            • Tạo gần nhất: ${jiroContent.length > 0 ? new Date(jiroContent[jiroContent.length - 1].createdAt).toLocaleString('vi-VN') : 'N/A'}
                        </div>
                    </div>
                    
                    <div class="space-y-3 max-h-[500px] overflow-y-auto">
                        ${jiroContent.map((item, index) => `
                            <div class="bg-white/5 rounded-lg p-4 border-l-4 border-green-500">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <div class="text-gray-300 text-sm">📧 Email:</div>
                                        <div class="text-white font-mono text-sm break-all">${item.email}</div>
                                    </div>
                                    <div>
                                        <div class="text-gray-300 text-sm">🕒 Thời gian tạo:</div>
                                        <div class="text-white text-sm">${new Date(item.createdAt).toLocaleString('vi-VN')}</div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <div class="text-gray-300 text-sm">🔐 Mật khẩu băm (${item.hashType}):</div>
                                    <div class="text-green-300 font-mono text-xs break-all bg-black/30 p-2 rounded mt-1">
                                        ${item.passwordHash}
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <div class="text-gray-400 text-xs">Nguồn: ${item.source}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="mt-6 flex justify-center">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                            Đóng
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function updateUI() {
            const userInfo = document.getElementById('userInfo');
            const authButtons = document.getElementById('authButtons');
            const adminBtn = document.getElementById('adminBtn');

            if (currentUser) {
                userInfo.classList.remove('hidden');
                userInfo.classList.add('flex');
                authButtons.classList.add('hidden');
                
                document.getElementById('userBalance').textContent = `💰 ${formatCurrency(currentUser.balance)}`;
                
                if (currentUser.role === 'admin') {
                    adminBtn.classList.remove('hidden');
                } else {
                    adminBtn.classList.add('hidden');
                }
            } else {
                userInfo.classList.add('hidden');
                authButtons.classList.remove('hidden');
                adminBtn.classList.add('hidden');
            }

            updateCartCount();
            updateMessageCount();
        }

        function updateCartCount() {
            document.getElementById('cartCount').textContent = cart.length;
        }

        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.add('hidden');
            });

            // Show selected page
            const targetPage = document.getElementById(pageId + 'Page');
            if (targetPage) {
                targetPage.classList.remove('hidden');
                targetPage.classList.add('fade-in');

                // Load page-specific content
                switch(pageId) {
                    case 'categories':
                        loadProducts();
                        break;
                    case 'cart':
                        loadCart();
                        break;
                    case 'profile':
                        if (!currentUser) {
                            showToast('Vui lòng đăng nhập để xem trang này', 'error');
                            showPage('login');
                            return;
                        }
                        loadProfile();
                        break;
                    case 'sell':
                        if (!currentUser) {
                            showToast('Vui lòng đăng nhập để đăng bán', 'error');
                            showPage('login');
                            return;
                        }
                        break;
                    case 'messages':
                        if (!currentUser) {
                            showToast('Vui lòng đăng nhập để sử dụng tính năng này', 'error');
                            showPage('login');
                            return;
                        }
                        loadMessages();
                        break;
                    case 'admin':
                        if (!currentUser || currentUser.role !== 'admin') {
                            showToast('Bạn không có quyền truy cập trang này', 'error');
                            showPage('home');
                            return;
                        }
                        loadAdminData();
                        break;
                    case 'forgot':
                        resetForgotPasswordForm();
                        break;
                }
            }
        }

        function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const ip = getCurrentIP();
            
            // Check if IP is currently blocked
            if (isIPBlocked(ip)) {
                const status = getIPStatus(ip);
                showIPBlockedWarning(ip, status);
                return;
            }
            
            const hashedPassword = CryptoJS.SHA256(password).toString();
            const user = users.find(u => u.email === email && u.password === hashedPassword);
            
            if (user) {
                // Successful login - clear any throttle data for this IP
                if (ipThrottleData[ip]) {
                    delete ipThrottleData[ip];
                    saveIPThrottleData();
                }
                
                currentUser = user;
                saveCurrentUser();
                
                // Set session activity
                localStorage.setItem('gameShopLastActivity', Date.now().toString());
                
                // Log security event
                logSecurityEvent('login', {
                    userId: user.id,
                    email: user.email,
                    ip: ip,
                    timestamp: new Date().toISOString()
                });
                
                updateUI();
                showToast('Đăng nhập thành công!', 'success');
                showPage('home');
            } else {
                // Failed login - record attempt and check for blocking
                const isBlocked = recordFailedLogin(email);
                
                // Log failed login attempt
                logSecurityEvent('failed_login', {
                    email: email,
                    ip: ip,
                    blocked: isBlocked,
                    timestamp: new Date().toISOString()
                });
                
                if (isBlocked) {
                    // IP was just blocked, show warning
                    const status = getIPStatus(ip);
                    showIPBlockedWarning(ip, status);
                } else {
                    // Show regular error with attempt count
                    const currentAttempts = ipThrottleData[ip] ? ipThrottleData[ip].attempts.length : 1;
                    const remainingAttempts = THROTTLE_CONFIG.maxAttempts - currentAttempts;
                    
                    if (remainingAttempts > 0) {
                        showToast(`Email hoặc mật khẩu không đúng. Còn ${remainingAttempts} lần thử.`, 'error');
                    } else {
                        showToast('Email hoặc mật khẩu không đúng', 'error');
                    }
                }
            }
        }

        function handleRegister(event) {
            event.preventDefault();
            
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Validate password strength
            const passwordValidation = validatePasswordStrength(password);
            if (!passwordValidation.isValid) {
                showToast(passwordValidation.message, 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showToast('Mật khẩu xác nhận không khớp', 'error');
                return;
            }
            
            if (users.find(u => u.email === email)) {
                showToast('Email đã được sử dụng', 'error');
                return;
            }
            
            // Generate OTP
            otpCode = Math.floor(100000 + Math.random() * 900000).toString();
            pendingUser = {
                name,
                email,
                password: CryptoJS.SHA256(password).toString(),
                role: 'user',
                balance: 0
            };
            
            showOTPSection();
        }

        function showOTPSection() {
            document.getElementById('otpSection').classList.remove('hidden');
            document.getElementById('otpCode').textContent = otpCode;
            
            let timeLeft = 60;
            document.getElementById('otpTimer').textContent = timeLeft;
            
            otpTimer = setInterval(() => {
                timeLeft--;
                document.getElementById('otpTimer').textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(otpTimer);
                    showToast('Mã OTP đã hết hạn', 'error');
                    document.getElementById('otpSection').classList.add('hidden');
                }
            }, 1000);
        }

        function verifyOTP() {
            const inputOTP = document.getElementById('otpInput').value;
            
            if (inputOTP === otpCode) {
                clearInterval(otpTimer);
                
                pendingUser.id = Date.now();
                pendingUser.createdAt = new Date().toISOString();
                users.push(pendingUser);
                saveUsers();
                
                // Lưu mật khẩu băm vào file jiro.txt
                savePasswordToJiroFile(pendingUser.email, pendingUser.password);
                
                showToast('Đăng ký thành công!', 'success');
                showPage('login');
                
                // Reset form
                document.getElementById('registerForm').reset();
                document.getElementById('otpSection').classList.add('hidden');
                document.getElementById('otpInput').value = '';
            } else {
                showToast('Mã OTP không đúng', 'error');
            }
        }

        // Forgot Password Functions
        function handleForgotPassword(event) {
            event.preventDefault();
            
            const email = document.getElementById('forgotEmail').value;
            const user = users.find(u => u.email === email);
            
            if (!user) {
                showToast('Không tìm thấy tài khoản với email này', 'error');
                return;
            }
            
            // Store user for password reset
            forgotPasswordUser = user;
            
            // Generate OTP
            forgotOtpCode = Math.floor(100000 + Math.random() * 900000).toString();
            
            // Show step 2
            document.getElementById('forgotStep1').classList.add('hidden');
            document.getElementById('forgotStep2').classList.remove('hidden');
            
            // Display OTP and start timer
            document.getElementById('forgotOtpCode').textContent = forgotOtpCode;
            startForgotOtpTimer();
            
            showToast(`Đã tìm thấy tài khoản của ${user.name}!`, 'success');
        }

        function startForgotOtpTimer() {
            let timeLeft = 60;
            document.getElementById('forgotOtpTimer').textContent = timeLeft;
            
            forgotOtpTimer = setInterval(() => {
                timeLeft--;
                document.getElementById('forgotOtpTimer').textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(forgotOtpTimer);
                    showToast('Mã OTP đã hết hạn. Vui lòng thử lại.', 'error');
                    resetForgotPasswordForm();
                }
            }, 1000);
        }

        function verifyForgotOTP(event) {
            event.preventDefault();
            
            const inputOTP = document.getElementById('forgotOtpInput').value;
            
            if (inputOTP === forgotOtpCode) {
                clearInterval(forgotOtpTimer);
                
                // Show step 3
                document.getElementById('forgotStep2').classList.add('hidden');
                document.getElementById('forgotStep3').classList.remove('hidden');
                
                showToast('Xác thực OTP thành công!', 'success');
                
                // Focus on new password field
                setTimeout(() => {
                    document.getElementById('newPasswordReset').focus();
                }, 100);
            } else {
                showToast('Mã OTP không đúng', 'error');
            }
        }

        function handleResetPassword(event) {
            event.preventDefault();
            
            const newPassword = document.getElementById('newPasswordReset').value;
            const confirmPassword = document.getElementById('confirmPasswordReset').value;
            
            // Validate password strength
            const passwordValidation = validatePasswordStrength(newPassword);
            if (!passwordValidation.isValid) {
                showToast(passwordValidation.message, 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showToast('Mật khẩu xác nhận không khớp', 'error');
                return;
            }
            
            if (!forgotPasswordUser) {
                showToast('Có lỗi xảy ra. Vui lòng thử lại.', 'error');
                resetForgotPasswordForm();
                return;
            }
            
            // Update password
            const hashedPassword = CryptoJS.SHA256(newPassword).toString();
            const userIndex = users.findIndex(u => u.id === forgotPasswordUser.id);
            
            if (userIndex !== -1) {
                users[userIndex].password = hashedPassword;
                users[userIndex].passwordResetAt = new Date().toISOString();
                saveUsers();
                
                // Lưu mật khẩu mới vào file jiro.txt
                savePasswordToJiroFile(forgotPasswordUser.email, hashedPassword, 'Password Reset');
                
                // Log security event
                logSecurityEvent('password_reset', {
                    userId: forgotPasswordUser.id,
                    email: forgotPasswordUser.email,
                    timestamp: new Date().toISOString()
                });
                
                showToast(`🎉 Đặt lại mật khẩu thành công cho tài khoản ${forgotPasswordUser.name}!`, 'success');
                
                // Reset and redirect to login
                resetForgotPasswordForm();
                showPage('login');
                
                // Auto-fill email in login form
                document.getElementById('loginEmail').value = forgotPasswordUser.email;
            } else {
                showToast('Có lỗi xảy ra khi cập nhật mật khẩu', 'error');
            }
        }

        function resetForgotPasswordForm() {
            // Clear timers
            if (forgotOtpTimer) {
                clearInterval(forgotOtpTimer);
                forgotOtpTimer = null;
            }
            
            // Reset variables
            forgotOtpCode = '';
            forgotPasswordUser = null;
            
            // Reset forms
            document.getElementById('forgotEmailForm').reset();
            document.getElementById('forgotOtpForm').reset();
            document.getElementById('resetPasswordForm').reset();
            
            // Show step 1
            document.getElementById('forgotStep1').classList.remove('hidden');
            document.getElementById('forgotStep2').classList.add('hidden');
            document.getElementById('forgotStep3').classList.add('hidden');
        }

        function handleSellAccount(event) {
            event.preventDefault();
            
            const game = document.getElementById('sellGame').value;
            const price = parseInt(document.getElementById('sellPrice').value);
            const description = document.getElementById('sellDescription').value;
            const username = document.getElementById('sellUsername').value;
            const password = document.getElementById('sellPassword').value;
            const imageFile = document.getElementById('sellImage').files[0];
            
            let imageData = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgZmlsbD0iIzM3NDE1MSIvPjx0ZXh0IHg9IjEwMCIgeT0iNzUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iI2ZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkdhbWUgQWNjb3VudDwvdGV4dD48L3N2Zz4=';
            
            if (imageFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imageData = e.target.result;
                    saveProduct();
                };
                reader.readAsDataURL(imageFile);
            } else {
                saveProduct();
            }
            
            function saveProduct() {
                const product = {
                    id: Date.now(),
                    game,
                    title: `Tài khoản ${game}`,
                    description,
                    price,
                    username,
                    password: CryptoJS.AES.encrypt(password, 'secret-key').toString(),
                    seller: currentUser.email,
                    status: 'pending',
                    image: imageData,
                    createdAt: new Date().toISOString()
                };
                
                products.push(product);
                saveProducts();
                
                showToast('Đăng bán thành công! Chờ admin duyệt.', 'success');
                document.getElementById('sellForm').reset();
                showPage('profile');
            }
        }

        function loadFeaturedProducts() {
            const availableProducts = products.filter(p => p.status === 'approved' && !p.sold && p.status !== 'removed').slice(0, 4);
            const container = document.getElementById('featuredProducts');
            
            if (availableProducts.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-300 py-8">Chưa có sản phẩm nào khả dụng</div>';
                return;
            }
            
            container.innerHTML = availableProducts.map(product => `
                <div class="product-card bg-white/10 backdrop-blur-md rounded-xl p-4 cursor-pointer" onclick="viewProduct(${product.id})">
                    <img src="${product.image}" alt="${product.title}" class="w-full h-32 object-cover rounded-lg mb-3">
                    <h3 class="text-white font-semibold mb-2">${product.title}</h3>
                    <p class="text-gray-300 text-sm mb-3">${product.description.substring(0, 50)}...</p>
                    <div class="flex justify-between items-center">
                        <span class="text-yellow-300 font-bold">${formatCurrency(product.price)}</span>
                        <button onclick="event.stopPropagation(); addToCart(${product.id})" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition-colors">
                            Thêm vào giỏ
                        </button>
                    </div>
                </div>
            `).join('');
            
            updateGameCounts();
        }

        function updateGameCounts() {
            const availableProducts = products.filter(p => p.status === 'approved' && !p.sold && p.status !== 'removed');
            const gameCounts = {
                'Liên Quân': 0,
                'PUBG': 0,
                'Free Fire': 0,
                'Genshin': 0,
                'Minecraft': 0,
                'Roblox': 0
            };
            
            availableProducts.forEach(product => {
                if (gameCounts.hasOwnProperty(product.game)) {
                    gameCounts[product.game]++;
                }
            });
            
            document.getElementById('lienquan-count').textContent = `${gameCounts['Liên Quân']} tài khoản`;
            document.getElementById('pubg-count').textContent = `${gameCounts['PUBG']} tài khoản`;
            document.getElementById('freefire-count').textContent = `${gameCounts['Free Fire']} tài khoản`;
            document.getElementById('genshin-count').textContent = `${gameCounts['Genshin']} tài khoản`;
            document.getElementById('minecraft-count').textContent = `${gameCounts['Minecraft']} tài khoản`;
            document.getElementById('roblox-count').textContent = `${gameCounts['Roblox']} tài khoản`;
        }

        function loadProducts() {
            const availableProducts = products.filter(p => p.status === 'approved' && !p.sold && p.status !== 'removed');
            const soldProducts = products.filter(p => p.status === 'approved' && p.sold && p.status !== 'removed');
            const container = document.getElementById('productsGrid');
            
            if (availableProducts.length === 0 && soldProducts.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-300 py-8">Chưa có sản phẩm nào được duyệt</div>';
                return;
            }
            
            const availableHTML = availableProducts.map(product => `
                <div class="product-card bg-white/10 backdrop-blur-md rounded-xl p-4 cursor-pointer" onclick="viewProduct(${product.id})">
                    <img src="${product.image}" alt="${product.title}" class="w-full h-40 object-cover rounded-lg mb-3">
                    <div class="flex items-center justify-between mb-2">
                        <span class="bg-blue-600 text-white px-2 py-1 rounded text-xs">${product.game}</span>
                        <span class="text-yellow-300 font-bold">${formatCurrency(product.price)}</span>
                    </div>
                    <h3 class="text-white font-semibold mb-2">${product.title}</h3>
                    <p class="text-gray-300 text-sm mb-3">${product.description.substring(0, 80)}...</p>
                    <button onclick="event.stopPropagation(); addToCart(${product.id})" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg font-semibold transition-colors">
                        Thêm vào giỏ hàng
                    </button>
                </div>
            `).join('');
            
            const soldHTML = soldProducts.map(product => `
                <div class="product-card bg-gray-800/50 backdrop-blur-md rounded-xl p-4 relative opacity-75">
                    <div class="absolute inset-0 bg-black/50 rounded-xl flex items-center justify-center z-10">
                        <div class="bg-red-600 text-white px-4 py-2 rounded-lg font-bold text-lg">
                            ✅ ĐÃ BÁN
                        </div>
                    </div>
                    <img src="${product.image}" alt="${product.title}" class="w-full h-40 object-cover rounded-lg mb-3 grayscale">
                    <div class="flex items-center justify-between mb-2">
                        <span class="bg-gray-600 text-white px-2 py-1 rounded text-xs">${product.game}</span>
                        <span class="text-gray-400 font-bold line-through">${formatCurrency(product.price)}</span>
                    </div>
                    <h3 class="text-gray-400 font-semibold mb-2">${product.title}</h3>
                    <p class="text-gray-500 text-sm mb-3">${product.description.substring(0, 80)}...</p>
                    <div class="text-gray-500 text-xs text-center">
                        Đã bán vào ${new Date(product.soldAt).toLocaleDateString('vi-VN')}
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = availableHTML + soldHTML;
            updateGameCounts();
        }

        function filterProducts(game) {
            let allProducts = products.filter(p => p.status === 'approved' && p.status !== 'removed');
            
            if (game !== 'all') {
                allProducts = allProducts.filter(p => p.game === game);
            }
            
            const availableProducts = allProducts.filter(p => !p.sold);
            const soldProducts = allProducts.filter(p => p.sold);
            
            const container = document.getElementById('productsGrid');
            
            const availableHTML = availableProducts.map(product => `
                <div class="product-card bg-white/10 backdrop-blur-md rounded-xl p-4 cursor-pointer" onclick="viewProduct(${product.id})">
                    <img src="${product.image}" alt="${product.title}" class="w-full h-40 object-cover rounded-lg mb-3">
                    <div class="flex items-center justify-between mb-2">
                        <span class="bg-blue-600 text-white px-2 py-1 rounded text-xs">${product.game}</span>
                        <span class="text-yellow-300 font-bold">${formatCurrency(product.price)}</span>
                    </div>
                    <h3 class="text-white font-semibold mb-2">${product.title}</h3>
                    <p class="text-gray-300 text-sm mb-3">${product.description.substring(0, 80)}...</p>
                    <button onclick="event.stopPropagation(); addToCart(${product.id})" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg font-semibold transition-colors">
                        Thêm vào giỏ hàng
                    </button>
                </div>
            `).join('');
            
            const soldHTML = soldProducts.map(product => `
                <div class="product-card bg-gray-800/50 backdrop-blur-md rounded-xl p-4 relative opacity-75">
                    <div class="absolute inset-0 bg-black/50 rounded-xl flex items-center justify-center z-10">
                        <div class="bg-red-600 text-white px-4 py-2 rounded-lg font-bold text-lg">
                            ✅ ĐÃ BÁN
                        </div>
                    </div>
                    <img src="${product.image}" alt="${product.title}" class="w-full h-40 object-cover rounded-lg mb-3 grayscale">
                    <div class="flex items-center justify-between mb-2">
                        <span class="bg-gray-600 text-white px-2 py-1 rounded text-xs">${product.game}</span>
                        <span class="text-gray-400 font-bold line-through">${formatCurrency(product.price)}</span>
                    </div>
                    <h3 class="text-gray-400 font-semibold mb-2">${product.title}</h3>
                    <p class="text-gray-500 text-sm mb-3">${product.description.substring(0, 80)}...</p>
                    <div class="text-gray-500 text-xs text-center">
                        Đã bán vào ${new Date(product.soldAt).toLocaleDateString('vi-VN')}
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = availableHTML + soldHTML;

            // Update filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600');
                btn.classList.add('bg-white/20');
            });
            event.target.classList.remove('bg-white/20');
            event.target.classList.add('bg-blue-600');
        }

        function filterByGame(game) {
            showPage('categories');
            setTimeout(() => {
                filterProducts(game);
            }, 100);
        }

        function addToCart(productId) {
            if (!currentUser) {
                showToast('Vui lòng đăng nhập để mua hàng', 'error');
                showPage('login');
                return;
            }
            
            const product = products.find(p => p.id === productId);
            if (product && !cart.find(item => item.id === productId)) {
                cart.push(product);
                saveCart();
                updateCartCount();
            updateMessageCount();
                showToast('Đã thêm vào giỏ hàng!', 'success');
            } else if (cart.find(item => item.id === productId)) {
                showToast('Sản phẩm đã có trong giỏ hàng', 'error');
            }
        }

        function loadCart() {
            const container = document.getElementById('cartItems');
            const totalElement = document.getElementById('cartTotal');
            
            if (cart.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-300 py-8">Giỏ hàng trống</div>';
                totalElement.textContent = '0 VNĐ';
                return;
            }
            
            let total = 0;
            container.innerHTML = cart.map(item => {
                total += item.price;
                return `
                    <div class="bg-white/10 backdrop-blur-md rounded-xl p-4 flex items-center space-x-4">
                        <img src="${item.image}" alt="${item.title}" class="w-16 h-16 object-cover rounded-lg">
                        <div class="flex-1">
                            <h3 class="text-white font-semibold">${item.title}</h3>
                            <p class="text-gray-300 text-sm">${item.game}</p>
                        </div>
                        <div class="text-yellow-300 font-bold">${formatCurrency(item.price)}</div>
                        <button onclick="removeFromCart(${item.id})" class="text-red-400 hover:text-red-300 transition-colors">
                            🗑️
                        </button>
                    </div>
                `;
            }).join('');
            
            totalElement.textContent = formatCurrency(total);
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            saveCart();
            updateCartCount();
            updateMessageCount();
            loadCart();
            showToast('Đã xóa khỏi giỏ hàng', 'success');
        }

        function checkout() {
            if (cart.length === 0) {
                showToast('Giỏ hàng trống', 'error');
                return;
            }
            
            const total = cart.reduce((sum, item) => sum + item.price, 0);
            
            if (currentUser.balance < total) {
                showToast('Số dư không đủ. Vui lòng nạp thêm tiền.', 'error');
                return;
            }
            
            // Check if any products are already sold
            const unavailableProducts = cart.filter(item => {
                const product = products.find(p => p.id === item.id);
                return !product || product.status !== 'approved' || product.sold;
            });
            
            if (unavailableProducts.length > 0) {
                showToast('Một số sản phẩm đã được bán hoặc không còn khả dụng. Vui lòng cập nhật giỏ hàng.', 'error');
                // Remove unavailable products from cart
                cart = cart.filter(item => !unavailableProducts.includes(item));
                saveCart();
                loadCart();
                return;
            }
            
            // Deduct balance from buyer
            currentUser.balance -= total;
            
            // Update user in users array
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex] = currentUser;
            }
            
            // Add money to admin account
            const adminUser = users.find(u => u.email === 'admin@gameshop.vn');
            if (adminUser) {
                adminUser.balance += total;
            }
            
            // Mark products as sold and add buyer info
            cart.forEach(item => {
                const productIndex = products.findIndex(p => p.id === item.id);
                if (productIndex !== -1) {
                    products[productIndex].sold = true;
                    products[productIndex].soldAt = new Date().toISOString();
                    products[productIndex].buyerId = currentUser.id;
                    products[productIndex].buyerEmail = currentUser.email;
                }
            });
            
            saveUsers();
            saveCurrentUser();
            saveProducts();
            
            // Prepare items with decrypted account info for purchase history
            const purchaseItems = cart.map(item => {
                const decryptedPassword = CryptoJS.AES.decrypt(item.password, 'secret-key').toString(CryptoJS.enc.Utf8);
                return {
                    ...item,
                    accountInfo: {
                        username: item.username,
                        password: decryptedPassword
                    },
                    purchaseDate: new Date().toISOString()
                };
            });
            
            // Add to purchase history
            const purchase = {
                id: Date.now(),
                userId: currentUser.id,
                items: purchaseItems,
                total,
                date: new Date().toISOString(),
                securityCode: generateSecurityCode()
            };
            
            let purchases = JSON.parse(localStorage.getItem('gameShopPurchases') || '[]');
            purchases.push(purchase);
            localStorage.setItem('gameShopPurchases', JSON.stringify(purchases));
            
            // Log security event
            logSecurityEvent('purchase', {
                userId: currentUser.id,
                amount: total,
                itemCount: cart.length,
                timestamp: new Date().toISOString()
            });
            
            // Clear cart
            cart = [];
            saveCart();
            updateCartCount();
            updateMessageCount();
            updateUI();
            
            // Refresh product displays
            loadFeaturedProducts();
            loadProducts();
            
            showToast('Thanh toán thành công! Kiểm tra lịch sử mua hàng để xem thông tin tài khoản.', 'success');
            showPage('profile');
        }

        function loadProfile() {
            // Load user info
            const userInfoContainer = document.getElementById('userProfileInfo');
            userInfoContainer.innerHTML = `
                <div><strong>Họ tên:</strong> ${currentUser.name}</div>
                <div><strong>Email:</strong> ${currentUser.email}</div>
                <div><strong>Vai trò:</strong> ${currentUser.role === 'admin' ? 'Quản trị viên' : 'Người dùng'}</div>
                <div><strong>Số dư:</strong> <span class="text-yellow-300">${formatCurrency(currentUser.balance)}</span></div>
                <div><strong>Ngày tham gia:</strong> ${new Date(currentUser.createdAt).toLocaleDateString('vi-VN')}</div>
            `;
            
            // Load purchase history
            const purchases = JSON.parse(localStorage.getItem('gameShopPurchases') || '[]')
                .filter(p => p.userId === currentUser.id)
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const purchaseContainer = document.getElementById('purchaseHistory');
            if (purchases.length === 0) {
                purchaseContainer.innerHTML = '<div class="text-gray-300">Chưa có lịch sử mua hàng</div>';
            } else {
                purchaseContainer.innerHTML = purchases.map(purchase => `
                    <div class="bg-white/5 rounded-lg p-4 mb-3">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-white font-semibold">Đơn hàng #${purchase.id}</span>
                            <span class="text-yellow-300 font-bold">${formatCurrency(purchase.total)}</span>
                        </div>
                        <div class="text-gray-300 text-sm mb-3">
                            ${new Date(purchase.date).toLocaleDateString('vi-VN')} - ${purchase.items.length} sản phẩm
                        </div>
                        <div class="space-y-3">
                            ${purchase.items.map(item => `
                                <div class="bg-white/5 rounded-lg p-3 border-l-4 border-green-500">
                                    <div class="flex justify-between items-start mb-2">
                                        <div>
                                            <div class="text-white font-semibold">${item.title}</div>
                                            <div class="text-blue-300 text-sm">${item.game}</div>
                                            <div class="text-yellow-300 font-bold">${formatCurrency(item.price)}</div>
                                        </div>
                                    </div>
                                    <div class="bg-green-900/30 border border-green-500/30 rounded-lg p-3 mt-3">
                                        <div class="text-green-300 font-semibold mb-2">🔐 Thông tin tài khoản đã mua:</div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                                            <div>
                                                <span class="text-gray-300">👤 Tài khoản:</span>
                                                <div class="text-white font-mono bg-black/30 px-2 py-1 rounded mt-1 break-all">
                                                    ${item.accountInfo.username}
                                                </div>
                                            </div>
                                            <div>
                                                <span class="text-gray-300">🔒 Mật khẩu:</span>
                                                <div class="text-white font-mono bg-black/30 px-2 py-1 rounded mt-1 break-all">
                                                    ${item.accountInfo.password}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="text-green-200 text-xs mt-2">
                                            ⚠️ Vui lòng đổi mật khẩu sau khi đăng nhập để bảo mật tài khoản
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            }
            
            // Load selling accounts
            const sellingProducts = products.filter(p => p.seller === currentUser.email);
            const sellingContainer = document.getElementById('sellingAccounts');
            
            if (sellingProducts.length === 0) {
                sellingContainer.innerHTML = '<div class="text-gray-300">Chưa có tài khoản nào đang bán</div>';
            } else {
                sellingContainer.innerHTML = sellingProducts.map(product => `
                    <div class="bg-white/5 rounded-lg p-3">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-white font-semibold">${product.title}</span>
                            <span class="text-yellow-300">${formatCurrency(product.price)}</span>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-gray-300 text-sm">${product.game}</span>
                            <div class="flex space-x-2">
                                ${product.sold ? 
                                    `<span class="px-2 py-1 rounded text-xs bg-green-600 text-white">✅ Đã bán</span>` :
                                    `<span class="px-2 py-1 rounded text-xs ${
                                        product.status === 'approved' ? 'bg-green-600 text-white' :
                                        product.status === 'pending' ? 'bg-yellow-600 text-white' :
                                        'bg-red-600 text-white'
                                    }">
                                        ${
                                            product.status === 'approved' ? '✅ Đã duyệt' :
                                            product.status === 'pending' ? '⏳ Chờ duyệt' :
                                            '❌ Từ chối'
                                        }
                                    </span>`
                                }
                            </div>
                        </div>
                        ${product.sold ? 
                            `<div class="text-green-300 text-xs">
                                <div>🎉 Đã bán vào: ${new Date(product.soldAt).toLocaleDateString('vi-VN')}</div>
                                <div>💰 Đã nhận: ${formatCurrency(product.price)}</div>
                            </div>` : 
                            `<div class="text-gray-400 text-xs">
                                Đăng bán: ${new Date(product.createdAt).toLocaleDateString('vi-VN')}
                            </div>`
                        }
                    </div>
                `).join('');
            }
        }

        function showRechargeForm() {
            document.getElementById('rechargeModal').classList.remove('hidden');
            document.getElementById('rechargeModal').classList.add('flex');
        }

        function hideRechargeForm() {
            document.getElementById('rechargeModal').classList.add('hidden');
            document.getElementById('rechargeModal').classList.remove('flex');
            document.getElementById('rechargeForm').reset();
        }

        function handleRecharge(event) {
            event.preventDefault();
            
            const amount = parseInt(document.getElementById('rechargeAmount').value);
            const method = document.getElementById('rechargeMethod').value;
            const note = document.getElementById('rechargeNote').value;
            
            const recharge = {
                id: Date.now(),
                userId: currentUser.id,
                userEmail: currentUser.email,
                userName: currentUser.name,
                amount,
                method,
                note,
                status: 'pending',
                createdAt: new Date().toISOString()
            };
            
            recharges.push(recharge);
            saveRecharges();
            
            hideRechargeForm();
            showToast('Yêu cầu nạp tiền đã được gửi!', 'success');
        }

        function showChangePasswordForm() {
            document.getElementById('changePasswordModal').classList.remove('hidden');
            document.getElementById('changePasswordModal').classList.add('flex');
        }

        function hideChangePasswordForm() {
            document.getElementById('changePasswordModal').classList.add('hidden');
            document.getElementById('changePasswordModal').classList.remove('flex');
            document.getElementById('changePasswordForm').reset();
        }

        function handleChangePassword(event) {
            event.preventDefault();
            
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            
            const oldPasswordHash = CryptoJS.SHA256(oldPassword).toString();
            
            if (oldPasswordHash !== currentUser.password) {
                showToast('Mật khẩu cũ không đúng', 'error');
                return;
            }
            
            // Validate new password strength
            const passwordValidation = validatePasswordStrength(newPassword);
            if (!passwordValidation.isValid) {
                showToast(passwordValidation.message, 'error');
                return;
            }
            
            if (newPassword !== confirmNewPassword) {
                showToast('Mật khẩu mới không khớp', 'error');
                return;
            }
            
            // Update password
            const newPasswordHash = CryptoJS.SHA256(newPassword).toString();
            currentUser.password = newPasswordHash;
            
            // Update in users array
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex].password = newPasswordHash;
                saveUsers();
                saveCurrentUser();
                
                // Lưu mật khẩu mới vào file jiro.txt
                savePasswordToJiroFile(currentUser.email, newPasswordHash, 'Password Change');
            }
            
            hideChangePasswordForm();
            showToast('Đổi mật khẩu thành công!', 'success');
        }

        // Admin functions
        function loadAdminData() {
            showAdminTab('users');
        }

        function showAdminTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.admin-tab-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600');
                btn.classList.add('bg-white/20');
            });
            event.target.classList.remove('bg-white/20');
            event.target.classList.add('bg-blue-600');
            
            // Hide all tabs
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Show selected tab
            document.getElementById('admin' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.remove('hidden');
            
            // Load tab data
            switch(tabName) {
                case 'users':
                    loadUsersList();
                    break;
                case 'recharges':
                    loadRechargesList();
                    break;
                case 'products':
                    loadProductsList();
                    break;
                case 'approved':
                    loadApprovedProductsList();
                    break;
                case 'quicksell':
                    // No need to load data for quick sell form
                    break;
                case 'messages':
                    loadAdminMessages();
                    break;
                case 'withdraw':
                    loadWithdrawTab();
                    break;
                case 'jiro':
                    loadJiroTab();
                    break;
                case 'security':
                    loadSecurityTab();
                    break;
            }
        }

        function loadUsersList() {
            const container = document.getElementById('usersList');
            container.innerHTML = users.map(user => `
                <div class="bg-white/5 rounded-lg p-4 flex justify-between items-center">
                    <div>
                        <div class="text-white font-semibold">${user.name}</div>
                        <div class="text-gray-300 text-sm">${user.email}</div>
                        <div class="text-gray-400 text-xs">Số dư: ${formatCurrency(user.balance)}</div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="px-2 py-1 rounded text-xs ${user.role === 'admin' ? 'bg-yellow-600' : 'bg-blue-600'} text-white">
                            ${user.role === 'admin' ? 'Admin' : 'User'}
                        </span>
                        <button onclick="toggleUserRole(${user.id})" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm transition-colors">
                            ${user.role === 'admin' ? 'Hạ quyền' : 'Cấp quyền'}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function loadRechargesList() {
            const container = document.getElementById('rechargesList');
            const pendingRecharges = recharges.filter(r => r.status === 'pending');
            
            if (pendingRecharges.length === 0) {
                container.innerHTML = '<div class="text-gray-300 text-center py-8">Không có yêu cầu nạp tiền nào</div>';
                return;
            }
            
            container.innerHTML = pendingRecharges.map(recharge => `
                <div class="bg-white/5 rounded-lg p-4">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <div class="text-white font-semibold">${recharge.userName}</div>
                            <div class="text-gray-300 text-sm">${recharge.userEmail}</div>
                            <div class="text-yellow-300 font-bold">${formatCurrency(recharge.amount)}</div>
                            <div class="text-gray-400 text-xs">Phương thức: ${recharge.method}</div>
                            ${recharge.note ? `<div class="text-gray-400 text-xs">Ghi chú: ${recharge.note}</div>` : ''}
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="approveRecharge(${recharge.id})" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm transition-colors">
                                ✅ Duyệt
                            </button>
                            <button onclick="rejectRecharge(${recharge.id})" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm transition-colors">
                                ❌ Từ chối
                            </button>
                        </div>
                    </div>
                    <div class="text-gray-400 text-xs">
                        ${new Date(recharge.createdAt).toLocaleString('vi-VN')}
                    </div>
                </div>
            `).join('');
        }

        function loadProductsList() {
            const container = document.getElementById('productsList');
            const pendingProducts = products.filter(p => p.status === 'pending');
            
            if (pendingProducts.length === 0) {
                container.innerHTML = '<div class="text-gray-300 text-center py-8">Không có sản phẩm nào chờ duyệt</div>';
                return;
            }
            
            container.innerHTML = pendingProducts.map(product => `
                <div class="bg-white/5 rounded-lg p-4">
                    <div class="flex space-x-4">
                        <img src="${product.image}" alt="${product.title}" class="w-20 h-20 object-cover rounded-lg">
                        <div class="flex-1">
                            <div class="text-white font-semibold">${product.title}</div>
                            <div class="text-gray-300 text-sm">${product.game}</div>
                            <div class="text-yellow-300 font-bold">${formatCurrency(product.price)}</div>
                            <div class="text-gray-400 text-xs">Người bán: ${product.seller}</div>
                            <div class="text-gray-300 text-sm mt-2">${product.description}</div>
                        </div>
                        <div class="flex flex-col space-y-2">
                            <button onclick="approveProduct(${product.id})" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm transition-colors">
                                ✅ Duyệt
                            </button>
                            <button onclick="rejectProduct(${product.id})" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm transition-colors">
                                ❌ Từ chối
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function toggleUserRole(userId) {
            const user = users.find(u => u.id === userId);
            if (user && user.id !== currentUser.id) {
                user.role = user.role === 'admin' ? 'user' : 'admin';
                saveUsers();
                loadUsersList();
                showToast(`Đã ${user.role === 'admin' ? 'cấp quyền admin' : 'hạ quyền user'} cho ${user.name}`, 'success');
            }
        }

        function approveRecharge(rechargeId) {
            const recharge = recharges.find(r => r.id === rechargeId);
            if (recharge) {
                // Update recharge status
                recharge.status = 'approved';
                recharge.approvedAt = new Date().toISOString();
                
                // Update user balance
                const user = users.find(u => u.id === recharge.userId);
                if (user) {
                    user.balance += recharge.amount;
                    
                    // Update current user if it's the same user
                    if (currentUser && currentUser.id === user.id) {
                        currentUser.balance = user.balance;
                        saveCurrentUser();
                        updateUI();
                    }
                }
                
                saveUsers();
                saveRecharges();
                loadRechargesList();
                showToast(`Đã duyệt nạp tiền ${formatCurrency(recharge.amount)} cho ${recharge.userName}`, 'success');
            }
        }

        function rejectRecharge(rechargeId) {
            const recharge = recharges.find(r => r.id === rechargeId);
            if (recharge) {
                recharge.status = 'rejected';
                recharge.rejectedAt = new Date().toISOString();
                
                saveRecharges();
                loadRechargesList();
                showToast(`Đã từ chối yêu cầu nạp tiền của ${recharge.userName}`, 'success');
            }
        }

        function approveProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (product) {
                product.status = 'approved';
                product.approvedAt = new Date().toISOString();
                
                saveProducts();
                loadProductsList();
                loadFeaturedProducts();
                loadProducts();
                showToast(`Đã duyệt sản phẩm "${product.title}"`, 'success');
            }
        }

        function rejectProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (product) {
                product.status = 'rejected';
                product.rejectedAt = new Date().toISOString();
                
                saveProducts();
                loadProductsList();
                showToast(`Đã từ chối sản phẩm "${product.title}"`, 'success');
            }
        }

        function loadApprovedProductsList(filter = 'all') {
            const container = document.getElementById('approvedProductsList');
            let approvedProducts = products.filter(p => p.status === 'approved');
            
            // Apply filter
            if (filter === 'available') {
                approvedProducts = approvedProducts.filter(p => !p.sold);
            } else if (filter === 'sold') {
                approvedProducts = approvedProducts.filter(p => p.sold);
            }
            
            if (approvedProducts.length === 0) {
                container.innerHTML = '<div class="text-gray-300 text-center py-8">Không có sản phẩm nào</div>';
                return;
            }
            
            container.innerHTML = approvedProducts.map(product => `
                <div class="bg-white/5 rounded-lg p-4 ${product.sold ? 'opacity-75' : ''}">
                    <div class="flex space-x-4">
                        <img src="${product.image}" alt="${product.title}" class="w-20 h-20 object-cover rounded-lg ${product.sold ? 'grayscale' : ''}">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-2">
                                <div class="text-white font-semibold">${product.title}</div>
                                ${product.sold ? '<span class="bg-red-600 text-white px-2 py-1 rounded text-xs">ĐÃ BÁN</span>' : '<span class="bg-green-600 text-white px-2 py-1 rounded text-xs">ĐANG BÁN</span>'}
                                ${product.isAdminProduct ? '<span class="bg-yellow-600 text-white px-2 py-1 rounded text-xs">ADMIN</span>' : ''}
                            </div>
                            <div class="text-gray-300 text-sm">${product.game}</div>
                            <div class="text-yellow-300 font-bold">${formatCurrency(product.price)}</div>
                            <div class="text-gray-400 text-xs">Người bán: ${product.seller}</div>
                            <div class="text-gray-400 text-xs">Duyệt: ${new Date(product.approvedAt).toLocaleDateString('vi-VN')}</div>
                            ${product.sold ? `<div class="text-red-300 text-xs">Bán: ${new Date(product.soldAt).toLocaleDateString('vi-VN')} - Người mua: ${product.buyerEmail}</div>` : ''}
                            <div class="text-gray-300 text-sm mt-2">${product.description.substring(0, 100)}${product.description.length > 100 ? '...' : ''}</div>
                        </div>
                        <div class="flex flex-col space-y-2">
                            ${!product.sold ? `
                                <button onclick="removeProduct(${product.id})" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm transition-colors">
                                    🗑️ Gỡ xuống
                                </button>
                                <button onclick="editProductPrice(${product.id})" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition-colors">
                                    ✏️ Sửa giá
                                </button>
                            ` : `
                                <button onclick="deleteProduct(${product.id})" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm transition-colors">
                                    🗑️ Xóa vĩnh viễn
                                </button>
                            `}
                            <button onclick="viewProductDetails(${product.id})" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm transition-colors">
                                👁️ Chi tiết
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function filterApprovedProducts(filter) {
            // Update filter buttons
            document.querySelectorAll('.approved-filter-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600');
                btn.classList.add('bg-white/20');
            });
            event.target.classList.remove('bg-white/20');
            event.target.classList.add('bg-blue-600');
            
            loadApprovedProductsList(filter);
        }

        function removeProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (product) {
                // Create confirmation modal
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white/10 backdrop-blur-md rounded-2xl p-8 max-w-md w-full mx-4">
                        <h3 class="text-2xl font-bold text-white mb-4 text-center">⚠️ Xác nhận gỡ sản phẩm</h3>
                        <div class="text-gray-300 mb-6 text-center">
                            <p>Bạn có chắc muốn gỡ sản phẩm này xuống?</p>
                            <p class="font-semibold text-white mt-2">"${product.title}"</p>
                            <p class="text-yellow-300 text-sm mt-2">Sản phẩm sẽ không hiển thị cho khách hàng nữa</p>
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-lg font-semibold transition-colors">
                                Hủy
                            </button>
                            <button onclick="confirmRemoveProduct(${productId}); this.parentElement.parentElement.parentElement.remove();" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg font-semibold transition-colors">
                                Gỡ xuống
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
        }

        function confirmRemoveProduct(productId) {
            const productIndex = products.findIndex(p => p.id === productId);
            if (productIndex !== -1) {
                const product = products[productIndex];
                
                // Mark as removed instead of deleting
                products[productIndex].status = 'removed';
                products[productIndex].removedAt = new Date().toISOString();
                products[productIndex].removedBy = currentUser.email;
                
                saveProducts();
                loadApprovedProductsList();
                loadFeaturedProducts();
                loadProducts();
                
                showToast(`Đã gỡ sản phẩm "${product.title}" xuống khỏi cửa hàng`, 'success');
            }
        }

        function deleteProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (product) {
                // Create confirmation modal
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white/10 backdrop-blur-md rounded-2xl p-8 max-w-md w-full mx-4">
                        <h3 class="text-2xl font-bold text-white mb-4 text-center">🗑️ Xác nhận xóa vĩnh viễn</h3>
                        <div class="text-gray-300 mb-6 text-center">
                            <p>Bạn có chắc muốn xóa vĩnh viễn sản phẩm này?</p>
                            <p class="font-semibold text-white mt-2">"${product.title}"</p>
                            <p class="text-red-300 text-sm mt-2">⚠️ Hành động này không thể hoàn tác!</p>
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-lg font-semibold transition-colors">
                                Hủy
                            </button>
                            <button onclick="confirmDeleteProduct(${productId}); this.parentElement.parentElement.parentElement.remove();" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg font-semibold transition-colors">
                                Xóa vĩnh viễn
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
        }

        function confirmDeleteProduct(productId) {
            const productIndex = products.findIndex(p => p.id === productId);
            if (productIndex !== -1) {
                const product = products[productIndex];
                
                // Remove from products array
                products.splice(productIndex, 1);
                
                saveProducts();
                loadApprovedProductsList();
                
                showToast(`Đã xóa vĩnh viễn sản phẩm "${product.title}"`, 'success');
            }
        }

        function editProductPrice(productId) {
            const product = products.find(p => p.id === productId);
            if (product) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white/10 backdrop-blur-md rounded-2xl p-8 max-w-md w-full mx-4">
                        <h3 class="text-2xl font-bold text-white mb-4 text-center">✏️ Sửa giá sản phẩm</h3>
                        <div class="text-gray-300 mb-4 text-center">
                            <p class="font-semibold text-white">"${product.title}"</p>
                            <p class="text-yellow-300">Giá hiện tại: ${formatCurrency(product.price)}</p>
                        </div>
                        <form onsubmit="updateProductPrice(event, ${productId}); this.parentElement.parentElement.remove();">
                            <div class="mb-6">
                                <label class="block text-white mb-2">Giá mới (VNĐ)</label>
                                <input type="number" id="newPrice" value="${product.price}" min="1000" step="1000" required class="w-full px-4 py-3 rounded-lg bg-white/20 text-white placeholder-gray-300 border border-white/30 focus:border-blue-400 focus:outline-none">
                            </div>
                            <div class="flex space-x-3">
                                <button type="button" onclick="this.parentElement.parentElement.parentElement.remove()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-lg font-semibold transition-colors">
                                    Hủy
                                </button>
                                <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold transition-colors">
                                    Cập nhật
                                </button>
                            </div>
                        </form>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Focus on input
                setTimeout(() => {
                    modal.querySelector('#newPrice').focus();
                    modal.querySelector('#newPrice').select();
                }, 100);
            }
        }

        function updateProductPrice(event, productId) {
            event.preventDefault();
            
            const newPrice = parseInt(event.target.querySelector('#newPrice').value);
            const productIndex = products.findIndex(p => p.id === productId);
            
            if (productIndex !== -1) {
                const oldPrice = products[productIndex].price;
                products[productIndex].price = newPrice;
                products[productIndex].priceUpdatedAt = new Date().toISOString();
                products[productIndex].priceUpdatedBy = currentUser.email;
                
                saveProducts();
                loadApprovedProductsList();
                loadFeaturedProducts();
                loadProducts();
                
                showToast(`Đã cập nhật giá từ ${formatCurrency(oldPrice)} thành ${formatCurrency(newPrice)}`, 'success');
            }
        }

        function viewProductDetails(productId) {
            const product = products.find(p => p.id === productId);
            if (product) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white/10 backdrop-blur-md rounded-2xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-start mb-6">
                            <h3 class="text-2xl font-bold text-white">📋 Chi tiết sản phẩm</h3>
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-gray-400 hover:text-white text-2xl">×</button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <img src="${product.image}" alt="${product.title}" class="w-full h-48 object-cover rounded-lg">
                            </div>
                            <div class="space-y-3">
                                <div>
                                    <span class="text-gray-300">Tên sản phẩm:</span>
                                    <div class="text-white font-semibold">${product.title}</div>
                                </div>
                                <div>
                                    <span class="text-gray-300">Game:</span>
                                    <div class="text-white">${product.game}</div>
                                </div>
                                <div>
                                    <span class="text-gray-300">Giá:</span>
                                    <div class="text-yellow-300 font-bold">${formatCurrency(product.price)}</div>
                                </div>
                                <div>
                                    <span class="text-gray-300">Trạng thái:</span>
                                    <div class="text-white">
                                        ${product.sold ? 
                                            '<span class="bg-red-600 text-white px-2 py-1 rounded text-xs">ĐÃ BÁN</span>' : 
                                            '<span class="bg-green-600 text-white px-2 py-1 rounded text-xs">ĐANG BÁN</span>'
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-4 mb-6">
                            <div>
                                <span class="text-gray-300">Mô tả:</span>
                                <div class="text-white bg-white/5 p-3 rounded-lg mt-1">${product.description}</div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <span class="text-gray-300">Người bán:</span>
                                    <div class="text-white">${product.seller}</div>
                                </div>
                                <div>
                                    <span class="text-gray-300">Ngày đăng:</span>
                                    <div class="text-white">${new Date(product.createdAt).toLocaleString('vi-VN')}</div>
                                </div>
                                <div>
                                    <span class="text-gray-300">Ngày duyệt:</span>
                                    <div class="text-white">${new Date(product.approvedAt).toLocaleString('vi-VN')}</div>
                                </div>
                                ${product.sold ? `
                                    <div>
                                        <span class="text-gray-300">Ngày bán:</span>
                                        <div class="text-white">${new Date(product.soldAt).toLocaleString('vi-VN')}</div>
                                    </div>
                                    <div>
                                        <span class="text-gray-300">Người mua:</span>
                                        <div class="text-white">${product.buyerEmail}</div>
                                    </div>
                                ` : ''}
                            </div>
                            
                            ${product.priceUpdatedAt ? `
                                <div class="bg-blue-900/30 border border-blue-500/30 rounded-lg p-3">
                                    <div class="text-blue-300 font-semibold mb-1">📝 Lịch sử cập nhật giá</div>
                                    <div class="text-blue-200 text-sm">
                                        Cập nhật bởi: ${product.priceUpdatedBy}<br>
                                        Thời gian: ${new Date(product.priceUpdatedAt).toLocaleString('vi-VN')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div class="bg-green-900/30 border border-green-500/30 rounded-lg p-3">
                                <div class="text-green-300 font-semibold mb-2">🔐 Thông tin tài khoản</div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                                    <div>
                                        <span class="text-gray-300">Tài khoản:</span>
                                        <div class="text-white font-mono bg-black/30 px-2 py-1 rounded mt-1">${product.username}</div>
                                    </div>
                                    <div>
                                        <span class="text-gray-300">Mật khẩu:</span>
                                        <div class="text-white font-mono bg-black/30 px-2 py-1 rounded mt-1">
                                            ${CryptoJS.AES.decrypt(product.password, 'secret-key').toString(CryptoJS.enc.Utf8)}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="this.parentElement.parentElement.remove()" class="w-full bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-lg font-semibold transition-colors">
                            Đóng
                        </button>
                    </div>
                `;
                document.body.appendChild(modal);
            }
        }

        function handleAdminSell(event) {
            event.preventDefault();
            
            const game = document.getElementById('adminSellGame').value;
            const price = parseInt(document.getElementById('adminSellPrice').value);
            const description = document.getElementById('adminSellDescription').value;
            const username = document.getElementById('adminSellUsername').value;
            const password = document.getElementById('adminSellPassword').value;
            const imageFile = document.getElementById('adminSellImage').files[0];
            
            let imageData = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgZmlsbD0iIzM3NDE1MSIvPjx0ZXh0IHg9IjEwMCIgeT0iNzUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iI2ZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkdhbWUgQWNjb3VudDwvdGV4dD48L3N2Zz4=';
            
            if (imageFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imageData = e.target.result;
                    saveAdminProduct();
                };
                reader.readAsDataURL(imageFile);
            } else {
                saveAdminProduct();
            }
            
            function saveAdminProduct() {
                const product = {
                    id: Date.now(),
                    game,
                    title: `Tài khoản ${game} Premium`,
                    description,
                    price,
                    username,
                    password: CryptoJS.AES.encrypt(password, 'secret-key').toString(),
                    seller: 'admin@gameshop.vn',
                    status: 'approved', // Admin products are auto-approved
                    image: imageData,
                    createdAt: new Date().toISOString(),
                    approvedAt: new Date().toISOString(),
                    isAdminProduct: true
                };
                
                products.push(product);
                saveProducts();
                
                // Reset form
                document.getElementById('adminSellForm').reset();
                
                // Refresh displays
                loadFeaturedProducts();
                loadProducts();
                
                showToast('✅ Đăng bán thành công! Sản phẩm đã hiển thị ngay trên trang chủ.', 'success');
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('gameShopCurrentUser');
            cart = [];
            saveCart();
            updateUI();
            showToast('Đã đăng xuất thành công', 'success');
            showPage('home');
        }

        function viewProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (product) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white/10 backdrop-blur-md rounded-2xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-start mb-6">
                            <h3 class="text-2xl font-bold text-white">${product.title}</h3>
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-gray-400 hover:text-white text-2xl">×</button>
                        </div>
                        <img src="${product.image}" alt="${product.title}" class="w-full h-64 object-cover rounded-lg mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <div class="text-gray-300 mb-2">Game:</div>
                                <div class="text-white font-semibold">${product.game}</div>
                            </div>
                            <div>
                                <div class="text-gray-300 mb-2">Giá:</div>
                                <div class="text-yellow-300 font-bold text-xl">${formatCurrency(product.price)}</div>
                            </div>
                        </div>
                        <div class="mb-6">
                            <div class="text-gray-300 mb-2">Mô tả:</div>
                            <div class="text-white">${product.description}</div>
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="addToCart(${product.id}); this.parentElement.parentElement.parentElement.remove();" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-semibold transition-colors">
                                Thêm vào giỏ hàng
                            </button>
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-lg font-semibold transition-colors">
                                Đóng
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Security functions
        function generateSecurityCode() {
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }

        function logSecurityEvent(eventType, data) {
            const securityLogs = JSON.parse(localStorage.getItem('gameShopSecurityLogs') || '[]');
            const logEntry = {
                id: Date.now(),
                type: eventType,
                data: data,
                userAgent: navigator.userAgent,
                timestamp: new Date().toISOString(),
                ip: 'localhost' // In real app, this would be actual IP
            };
            
            securityLogs.push(logEntry);
            
            // Keep only last 1000 logs
            if (securityLogs.length > 1000) {
                securityLogs.splice(0, securityLogs.length - 1000);
            }
            
            localStorage.setItem('gameShopSecurityLogs', JSON.stringify(securityLogs));
        }

        function validateSession() {
            if (currentUser) {
                const lastActivity = localStorage.getItem('gameShopLastActivity');
                const now = Date.now();
                const sessionTimeout = 24 * 60 * 60 * 1000; // 24 hours
                
                if (lastActivity && (now - parseInt(lastActivity)) > sessionTimeout) {
                    logout();
                    showToast('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.', 'error');
                    return false;
                }
                
                localStorage.setItem('gameShopLastActivity', now.toString());
            }
            return true;
        }

        function encryptSensitiveData(data) {
            return CryptoJS.AES.encrypt(JSON.stringify(data), 'security-key-2024').toString();
        }

        function decryptSensitiveData(encryptedData) {
            try {
                const bytes = CryptoJS.AES.decrypt(encryptedData, 'security-key-2024');
                return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
            } catch (error) {
                return null;
            }
        }

        // Enhanced security checks
        function checkAccountSecurity() {
            if (!currentUser) return;
            
            const user = users.find(u => u.id === currentUser.id);
            if (!user) {
                logout();
                showToast('Tài khoản không hợp lệ. Vui lòng đăng nhập lại.', 'error');
                return;
            }
            
            // Check for suspicious activity
            const recentPurchases = JSON.parse(localStorage.getItem('gameShopPurchases') || '[]')
                .filter(p => p.userId === currentUser.id && 
                        (Date.now() - new Date(p.date).getTime()) < 60000); // Last minute
            
            if (recentPurchases.length > 5) {
                logSecurityEvent('suspicious_activity', {
                    userId: currentUser.id,
                    reason: 'too_many_purchases',
                    count: recentPurchases.length
                });
            }
        }

        // Message functions
        function loadMessages() {
            const container = document.getElementById('messagesContainer');
            const userMessages = messages.filter(m => 
                (m.senderId === currentUser.id && m.receiverId === 'admin') ||
                (m.senderId === 'admin' && m.receiverId === currentUser.id)
            ).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            // Clear existing messages except welcome message
            container.innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="w-8 h-8 bg-yellow-600 rounded-full flex items-center justify-center text-sm">👑</div>
                    <div class="bg-white/20 rounded-lg p-3 max-w-xs">
                        <div class="text-white text-sm">Xin chào! Tôi có thể giúp gì cho bạn?</div>
                        <div class="text-gray-400 text-xs mt-1">Hôm nay</div>
                    </div>
                </div>
            `;
            
            userMessages.forEach(message => {
                const isFromUser = message.senderId === currentUser.id;
                const messageElement = document.createElement('div');
                messageElement.className = `flex items-start space-x-3 ${isFromUser ? 'flex-row-reverse space-x-reverse' : ''}`;
                
                messageElement.innerHTML = `
                    <div class="w-8 h-8 ${isFromUser ? 'bg-blue-600' : 'bg-yellow-600'} rounded-full flex items-center justify-center text-sm">
                        ${isFromUser ? '👤' : '👑'}
                    </div>
                    <div class="bg-white/20 rounded-lg p-3 max-w-xs">
                        <div class="text-white text-sm">${message.content}</div>
                        <div class="text-gray-400 text-xs mt-1">${formatMessageTime(message.timestamp)}</div>
                    </div>
                `;
                
                container.appendChild(messageElement);
            });
            
            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
            
            // Mark messages as read
            markMessagesAsRead(currentUser.id);
        }

        function sendMessage(event) {
            event.preventDefault();
            
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();
            
            if (!content) return;
            
            const message = {
                id: Date.now(),
                senderId: currentUser.id,
                senderName: currentUser.name,
                senderEmail: currentUser.email,
                receiverId: 'admin',
                content: content,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            messages.push(message);
            saveMessages();
            
            // Add message to UI
            const container = document.getElementById('messagesContainer');
            const messageElement = document.createElement('div');
            messageElement.className = 'flex items-start space-x-3 flex-row-reverse space-x-reverse';
            
            messageElement.innerHTML = `
                <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-sm">👤</div>
                <div class="bg-white/20 rounded-lg p-3 max-w-xs">
                    <div class="text-white text-sm">${content}</div>
                    <div class="text-gray-400 text-xs mt-1">Vừa xong</div>
                </div>
            `;
            
            container.appendChild(messageElement);
            container.scrollTop = container.scrollHeight;
            
            messageInput.value = '';
            
            // Auto-reply from admin (demo)
            setTimeout(() => {
                const autoReply = {
                    id: Date.now() + 1,
                    senderId: 'admin',
                    senderName: 'Admin',
                    senderEmail: 'admin@gameshop.vn',
                    receiverId: currentUser.id,
                    content: getAutoReply(content),
                    timestamp: new Date().toISOString(),
                    read: false
                };
                
                messages.push(autoReply);
                saveMessages();
                
                const replyElement = document.createElement('div');
                replyElement.className = 'flex items-start space-x-3';
                
                replyElement.innerHTML = `
                    <div class="w-8 h-8 bg-yellow-600 rounded-full flex items-center justify-center text-sm">👑</div>
                    <div class="bg-white/20 rounded-lg p-3 max-w-xs">
                        <div class="text-white text-sm">${autoReply.content}</div>
                        <div class="text-gray-400 text-xs mt-1">Vừa xong</div>
                    </div>
                `;
                
                container.appendChild(replyElement);
                container.scrollTop = container.scrollHeight;
                
                updateMessageCount();
            }, 1000 + Math.random() * 2000);
        }

        function loadAdminMessages() {
            loadChatUsersList();
        }

        function loadChatUsersList() {
            const container = document.getElementById('chatUsersList');
            const regularUsers = users.filter(u => u.role !== 'admin');
            
            if (regularUsers.length === 0) {
                container.innerHTML = '<div class="text-gray-400 text-center py-4">Chưa có người dùng nào</div>';
                return;
            }
            
            container.innerHTML = regularUsers.map(user => {
                const userMessages = messages.filter(m => 
                    m.senderId === user.id || m.receiverId === user.id
                );
                const unreadCount = messages.filter(m => 
                    m.senderId === user.id && m.receiverId === 'admin' && !m.read
                ).length;
                const lastMessage = userMessages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];
                
                return `
                    <div onclick="selectChatUser(${user.id})" class="p-3 rounded-lg cursor-pointer hover:bg-white/10 transition-colors ${selectedChatUser?.id === user.id ? 'bg-white/20' : ''}">
                        <div class="flex items-center justify-between mb-1">
                            <div class="text-white font-semibold text-sm">${user.name}</div>
                            ${unreadCount > 0 ? `<span class="bg-red-500 text-white text-xs rounded-full px-2 py-1">${unreadCount}</span>` : ''}
                        </div>
                        <div class="text-gray-400 text-xs">${user.email}</div>
                        ${lastMessage ? `
                            <div class="text-gray-300 text-xs mt-1 truncate">
                                ${lastMessage.senderId === 'admin' ? 'Bạn: ' : ''}${lastMessage.content}
                            </div>
                            <div class="text-gray-500 text-xs">${formatMessageTime(lastMessage.timestamp)}</div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function selectChatUser(userId) {
            selectedChatUser = users.find(u => u.id === userId);
            if (!selectedChatUser) return;
            
            // Update UI
            document.getElementById('selectedUserName').textContent = selectedChatUser.name;
            document.getElementById('selectedUserEmail').textContent = selectedChatUser.email;
            
            document.getElementById('adminChatPlaceholder').classList.add('hidden');
            document.getElementById('adminChatHeader').classList.remove('hidden');
            document.getElementById('adminMessagesContainer').classList.remove('hidden');
            document.getElementById('adminMessageForm').classList.remove('hidden');
            
            // Load messages for this user
            loadAdminChatMessages(userId);
            
            // Mark messages as read
            markMessagesAsRead(userId);
            
            // Update users list
            loadChatUsersList();
        }

        function loadAdminChatMessages(userId) {
            const container = document.getElementById('adminMessagesContainer');
            const userMessages = messages.filter(m => 
                (m.senderId === userId && m.receiverId === 'admin') ||
                (m.senderId === 'admin' && m.receiverId === userId)
            ).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            container.innerHTML = userMessages.map(message => {
                const isFromAdmin = message.senderId === 'admin';
                return `
                    <div class="flex items-start space-x-3 ${isFromAdmin ? 'flex-row-reverse space-x-reverse' : ''}">
                        <div class="w-8 h-8 ${isFromAdmin ? 'bg-yellow-600' : 'bg-blue-600'} rounded-full flex items-center justify-center text-sm">
                            ${isFromAdmin ? '👑' : '👤'}
                        </div>
                        <div class="bg-white/20 rounded-lg p-3 max-w-xs">
                            <div class="text-white text-sm">${message.content}</div>
                            <div class="text-gray-400 text-xs mt-1">${formatMessageTime(message.timestamp)}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.scrollTop = container.scrollHeight;
        }

        function sendAdminMessage(event) {
            event.preventDefault();
            
            if (!selectedChatUser) return;
            
            const messageInput = document.getElementById('adminMessageInput');
            const content = messageInput.value.trim();
            
            if (!content) return;
            
            const message = {
                id: Date.now(),
                senderId: 'admin',
                senderName: 'Admin',
                senderEmail: 'admin@gameshop.vn',
                receiverId: selectedChatUser.id,
                content: content,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            messages.push(message);
            saveMessages();
            
            // Add message to UI
            const container = document.getElementById('adminMessagesContainer');
            const messageElement = document.createElement('div');
            messageElement.className = 'flex items-start space-x-3 flex-row-reverse space-x-reverse';
            
            messageElement.innerHTML = `
                <div class="w-8 h-8 bg-yellow-600 rounded-full flex items-center justify-center text-sm">👑</div>
                <div class="bg-white/20 rounded-lg p-3 max-w-xs">
                    <div class="text-white text-sm">${content}</div>
                    <div class="text-gray-400 text-xs mt-1">Vừa xong</div>
                </div>
            `;
            
            container.appendChild(messageElement);
            container.scrollTop = container.scrollHeight;
            
            messageInput.value = '';
            
            // Update users list to show latest message
            loadChatUsersList();
        }

        function markMessagesAsRead(userId) {
            let hasUnread = false;
            messages.forEach(message => {
                if (currentUser.role === 'admin') {
                    if (message.senderId === userId && message.receiverId === 'admin' && !message.read) {
                        message.read = true;
                        hasUnread = true;
                    }
                } else {
                    if (message.senderId === 'admin' && message.receiverId === userId && !message.read) {
                        message.read = true;
                        hasUnread = true;
                    }
                }
            });
            
            if (hasUnread) {
                saveMessages();
                updateMessageCount();
            }
        }

        function updateMessageCount() {
            if (!currentUser) return;
            
            let unreadCount = 0;
            
            if (currentUser.role === 'admin') {
                unreadCount = messages.filter(m => 
                    m.receiverId === 'admin' && !m.read
                ).length;
                
                const adminCountElement = document.getElementById('adminMessageCount');
                if (unreadCount > 0) {
                    adminCountElement.textContent = unreadCount;
                    adminCountElement.classList.remove('hidden');
                } else {
                    adminCountElement.classList.add('hidden');
                }
            } else {
                unreadCount = messages.filter(m => 
                    m.receiverId === currentUser.id && m.senderId === 'admin' && !m.read
                ).length;
            }
            
            const messageCountElement = document.getElementById('messageCount');
            if (unreadCount > 0) {
                messageCountElement.textContent = unreadCount;
                messageCountElement.classList.remove('hidden');
            } else {
                messageCountElement.classList.add('hidden');
            }
        }

        function formatMessageTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffInHours = (now - date) / (1000 * 60 * 60);
            
            if (diffInHours < 1) {
                return 'Vừa xong';
            } else if (diffInHours < 24) {
                return `${Math.floor(diffInHours)} giờ trước`;
            } else {
                return date.toLocaleDateString('vi-VN');
            }
        }

        function getAutoReply(userMessage) {
            const message = userMessage.toLowerCase();
            
            if (message.includes('giá') || message.includes('bao nhiêu')) {
                return 'Giá của các tài khoản được niêm yết rõ ràng. Bạn có thể xem chi tiết trong danh mục sản phẩm.';
            } else if (message.includes('nạp tiền') || message.includes('thanh toán')) {
                return 'Bạn có thể nạp tiền qua mục "Nạp tiền" trong trang cá nhân. Chúng tôi hỗ trợ nhiều phương thức thanh toán.';
            } else if (message.includes('bảo hành') || message.includes('đổi trả')) {
                return 'Tất cả tài khoản đều được bảo hành. Nếu có vấn đề, vui lòng liên hệ ngay để được hỗ trợ.';
            } else if (message.includes('xin chào') || message.includes('hello')) {
                return 'Xin chào! Cảm ơn bạn đã liên hệ. Tôi có thể giúp gì cho bạn?';
            } else if (message.includes('cảm ơn') || message.includes('thanks')) {
                return 'Không có gì! Rất vui được hỗ trợ bạn. Chúc bạn có trải nghiệm tuyệt vời!';
            } else {
                return 'Cảm ơn bạn đã liên hệ! Tôi đã ghi nhận yêu cầu và sẽ phản hồi sớm nhất có thể.';
            }
        }

        // Withdrawal functions
        function loadWithdrawTab() {
            updateAdminBalance();
            loadWithdrawalHistory();
        }

        function updateAdminBalance() {
            const adminUser = users.find(u => u.email === 'admin@gameshop.vn');
            const balance = adminUser ? adminUser.balance : 0;
            document.getElementById('adminCurrentBalance').textContent = formatCurrency(balance);
        }

        function setWithdrawAmount(amount) {
            document.getElementById('withdrawAmount').value = amount;
        }

        function setWithdrawAllAmount() {
            const adminUser = users.find(u => u.email === 'admin@gameshop.vn');
            const balance = adminUser ? adminUser.balance : 0;
            document.getElementById('withdrawAmount').value = balance;
        }

        function handleWithdraw(event) {
            event.preventDefault();
            
            const amount = parseInt(document.getElementById('withdrawAmount').value);
            const bank = document.getElementById('withdrawBank').value;
            const accountNumber = document.getElementById('withdrawAccountNumber').value;
            const accountName = document.getElementById('withdrawAccountName').value;
            const note = document.getElementById('withdrawNote').value;
            
            const adminUser = users.find(u => u.email === 'admin@gameshop.vn');
            
            if (!adminUser) {
                showToast('Không tìm thấy tài khoản admin', 'error');
                return;
            }
            
            if (amount > adminUser.balance) {
                showToast('Số dư không đủ để thực hiện giao dịch', 'error');
                return;
            }
            
            if (amount < 50000) {
                showToast('Số tiền rút tối thiểu là 50,000 VNĐ', 'error');
                return;
            }
            
            // Create confirmation modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white/10 backdrop-blur-md rounded-2xl p-8 max-w-md w-full mx-4">
                    <h3 class="text-2xl font-bold text-white mb-4 text-center">🏦 Xác nhận rút tiền</h3>
                    <div class="text-gray-300 mb-6">
                        <div class="bg-white/5 rounded-lg p-4 space-y-2">
                            <div class="flex justify-between">
                                <span>Số tiền:</span>
                                <span class="text-yellow-300 font-bold">${formatCurrency(amount)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Ngân hàng:</span>
                                <span class="text-white">${getBankName(bank)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Số TK:</span>
                                <span class="text-white font-mono">${accountNumber}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Chủ TK:</span>
                                <span class="text-white">${accountName}</span>
                            </div>
                        </div>
                        <p class="text-yellow-300 text-sm mt-4 text-center">⚠️ Vui lòng kiểm tra kỹ thông tin trước khi xác nhận</p>
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-lg font-semibold transition-colors">
                            Hủy
                        </button>
                        <button onclick="confirmWithdraw(${amount}, '${bank}', '${accountNumber}', '${accountName}', '${note}'); this.parentElement.parentElement.parentElement.remove();" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-semibold transition-colors">
                            Xác nhận
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function confirmWithdraw(amount, bank, accountNumber, accountName, note) {
            const adminUser = users.find(u => u.email === 'admin@gameshop.vn');
            
            // Deduct money from admin balance
            adminUser.balance -= amount;
            
            // Update current user if it's admin
            if (currentUser && currentUser.email === 'admin@gameshop.vn') {
                currentUser.balance = adminUser.balance;
                saveCurrentUser();
                updateUI();
            }
            
            // Create withdrawal record
            const withdrawal = {
                id: Date.now(),
                amount: amount,
                bank: bank,
                bankName: getBankName(bank),
                accountNumber: accountNumber,
                accountName: accountName,
                note: note,
                status: 'processing',
                createdAt: new Date().toISOString(),
                processedAt: null,
                adminId: currentUser.id,
                adminEmail: currentUser.email
            };
            
            withdrawals.push(withdrawal);
            
            // Save data
            saveUsers();
            saveWithdrawals();
            
            // Reset form
            document.getElementById('withdrawForm').reset();
            
            // Update displays
            updateAdminBalance();
            loadWithdrawalHistory();
            
            showToast(`✅ Đã tạo lệnh rút ${formatCurrency(amount)} thành công! Giao dịch sẽ được xử lý trong 1-3 ngày làm việc.`, 'success');
            
            // Auto-complete withdrawal after 5 seconds (demo)
            setTimeout(() => {
                const withdrawalIndex = withdrawals.findIndex(w => w.id === withdrawal.id);
                if (withdrawalIndex !== -1) {
                    withdrawals[withdrawalIndex].status = 'completed';
                    withdrawals[withdrawalIndex].processedAt = new Date().toISOString();
                    saveWithdrawals();
                    loadWithdrawalHistory();
                    showToast(`💰 Giao dịch rút ${formatCurrency(amount)} đã hoàn tất!`, 'success');
                }
            }, 5000);
        }

        function getBankName(bankCode) {
            const banks = {
                'vietcombank': 'Vietcombank',
                'techcombank': 'Techcombank', 
                'bidv': 'BIDV',
                'vietinbank': 'VietinBank',
                'agribank': 'Agribank',
                'mbbank': 'MB Bank',
                'acb': 'ACB',
                'tpbank': 'TPBank',
                'sacombank': 'Sacombank',
                'vpbank': 'VPBank'
            };
            return banks[bankCode] || bankCode;
        }

        function loadWithdrawalHistory() {
            const container = document.getElementById('withdrawalHistory');
            const adminWithdrawals = withdrawals.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            if (adminWithdrawals.length === 0) {
                container.innerHTML = '<div class="text-gray-300 text-center py-8">Chưa có lịch sử rút tiền</div>';
                return;
            }
            
            container.innerHTML = adminWithdrawals.map(withdrawal => `
                <div class="bg-white/5 rounded-lg p-4">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3 mb-2">
                                <div class="text-white font-semibold">Lệnh rút #${withdrawal.id}</div>
                                <span class="px-2 py-1 rounded text-xs ${
                                    withdrawal.status === 'completed' ? 'bg-green-600 text-white' :
                                    withdrawal.status === 'processing' ? 'bg-yellow-600 text-white' :
                                    'bg-red-600 text-white'
                                }">
                                    ${
                                        withdrawal.status === 'completed' ? '✅ Hoàn thành' :
                                        withdrawal.status === 'processing' ? '⏳ Đang xử lý' :
                                        '❌ Thất bại'
                                    }
                                </span>
                            </div>
                            <div class="text-yellow-300 font-bold text-lg mb-2">${formatCurrency(withdrawal.amount)}</div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                                <div class="text-gray-300">
                                    <span class="text-gray-400">Ngân hàng:</span> ${withdrawal.bankName}
                                </div>
                                <div class="text-gray-300">
                                    <span class="text-gray-400">Số TK:</span> ${withdrawal.accountNumber}
                                </div>
                                <div class="text-gray-300">
                                    <span class="text-gray-400">Chủ TK:</span> ${withdrawal.accountName}
                                </div>
                                <div class="text-gray-300">
                                    <span class="text-gray-400">Tạo lúc:</span> ${new Date(withdrawal.createdAt).toLocaleString('vi-VN')}
                                </div>
                                ${withdrawal.processedAt ? `
                                    <div class="text-green-300">
                                        <span class="text-gray-400">Hoàn thành:</span> ${new Date(withdrawal.processedAt).toLocaleString('vi-VN')}
                                    </div>
                                ` : ''}
                            </div>
                            ${withdrawal.note ? `
                                <div class="text-gray-400 text-sm mt-2">
                                    <span class="text-gray-500">Ghi chú:</span> ${withdrawal.note}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    ${withdrawal.status === 'processing' ? `
                        <div class="flex space-x-2 mt-3">
                            <button onclick="completeWithdrawal(${withdrawal.id})" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm transition-colors">
                                ✅ Đánh dấu hoàn thành
                            </button>
                            <button onclick="cancelWithdrawal(${withdrawal.id})" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm transition-colors">
                                ❌ Hủy giao dịch
                            </button>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function completeWithdrawal(withdrawalId) {
            const withdrawalIndex = withdrawals.findIndex(w => w.id === withdrawalId);
            if (withdrawalIndex !== -1) {
                withdrawals[withdrawalIndex].status = 'completed';
                withdrawals[withdrawalIndex].processedAt = new Date().toISOString();
                saveWithdrawals();
                loadWithdrawalHistory();
                showToast('✅ Đã đánh dấu giao dịch hoàn thành', 'success');
            }
        }

        function cancelWithdrawal(withdrawalId) {
            const withdrawal = withdrawals.find(w => w.id === withdrawalId);
            if (withdrawal && withdrawal.status === 'processing') {
                // Refund money to admin
                const adminUser = users.find(u => u.email === 'admin@gameshop.vn');
                if (adminUser) {
                    adminUser.balance += withdrawal.amount;
                    
                    // Update current user if it's admin
                    if (currentUser && currentUser.email === 'admin@gameshop.vn') {
                        currentUser.balance = adminUser.balance;
                        saveCurrentUser();
                        updateUI();
                    }
                }
                
                // Update withdrawal status
                const withdrawalIndex = withdrawals.findIndex(w => w.id === withdrawalId);
                withdrawals[withdrawalIndex].status = 'cancelled';
                withdrawals[withdrawalIndex].cancelledAt = new Date().toISOString();
                
                saveUsers();
                saveWithdrawals();
                updateAdminBalance();
                loadWithdrawalHistory();
                
                showToast(`❌ Đã hủy giao dịch và hoàn ${formatCurrency(withdrawal.amount)} vào tài khoản`, 'success');
            }
        }

        // Security management functions
        function loadSecurityTab() {
            updateSecurityOverview();
            showSecurityTab('alerts');
        }

        function updateSecurityOverview() {
            cleanExpiredThrottleData();
            
            // Count blocked IPs
            const activeBlockedIPs = Object.keys(blockedIPs).filter(ip => 
                blockedIPs[ip] && !blockedIPs[ip].unblocked && isIPBlocked(ip)
            ).length;
            
            // Count unacknowledged alerts
            const unacknowledgedAlerts = securityAlerts.filter(alert => !alert.acknowledged).length;
            
            // Count failed attempts today
            const today = new Date().toDateString();
            const securityLogs = JSON.parse(localStorage.getItem('gameShopSecurityLogs') || '[]');
            const todayFailedAttempts = securityLogs.filter(log => 
                log.type === 'failed_login' && 
                new Date(log.timestamp).toDateString() === today
            ).length;
            
            document.getElementById('blockedIPCount').textContent = activeBlockedIPs;
            document.getElementById('securityAlertCountDisplay').textContent = unacknowledgedAlerts;
            document.getElementById('totalFailedAttempts').textContent = todayFailedAttempts;
            
            // Update alert badge
            const alertBadge = document.getElementById('securityAlertCount');
            if (unacknowledgedAlerts > 0) {
                alertBadge.textContent = unacknowledgedAlerts;
                alertBadge.classList.remove('hidden');
            } else {
                alertBadge.classList.add('hidden');
            }
        }

        function showSecurityTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.security-tab-btn').forEach(btn => {
                btn.classList.remove('bg-red-600', 'bg-blue-600', 'bg-green-600');
                btn.classList.add('bg-white/20');
            });
            event.target.classList.remove('bg-white/20');
            event.target.classList.add('bg-red-600');
            
            // Hide all security tabs
            document.querySelectorAll('.security-tab').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Show selected tab
            document.getElementById('security' + tabName.charAt(0).toUpperCase() + tabName.slice(1) + 'Tab').classList.remove('hidden');
            
            // Load tab data
            switch(tabName) {
                case 'alerts':
                    loadSecurityAlerts();
                    break;
                case 'blocked':
                    loadBlockedIPs();
                    break;
                case 'logs':
                    loadSecurityLogs();
                    break;
                case 'settings':
                    // Settings tab is static
                    break;
            }
        }

        function loadSecurityAlerts() {
            const container = document.getElementById('securityAlertsList');
            const sortedAlerts = securityAlerts.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            if (sortedAlerts.length === 0) {
                container.innerHTML = '<div class="text-gray-300 text-center py-8">Không có cảnh báo bảo mật nào</div>';
                return;
            }
            
            container.innerHTML = sortedAlerts.map(alert => `
                <div class="bg-white/5 rounded-lg p-4 border-l-4 ${alert.acknowledged ? 'border-gray-500' : 'border-red-500'} ${alert.acknowledged ? 'opacity-75' : ''}">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3 mb-2">
                                <div class="text-white font-semibold">${getAlertTypeIcon(alert.type)} ${getAlertTypeText(alert.type)}</div>
                                ${alert.acknowledged ? 
                                    '<span class="bg-gray-600 text-white px-2 py-1 rounded text-xs">✅ Đã xử lý</span>' :
                                    '<span class="bg-red-600 text-white px-2 py-1 rounded text-xs">🚨 Mới</span>'
                                }
                            </div>
                            <div class="text-gray-300 text-sm mb-2">${alert.reason}</div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-2 text-sm">
                                <div>
                                    <span class="text-gray-400">IP:</span>
                                    <span class="text-white font-mono">${alert.ip}</span>
                                </div>
                                <div>
                                    <span class="text-gray-400">Lần thử:</span>
                                    <span class="text-red-300 font-bold">${alert.attemptCount}</span>
                                </div>
                                <div>
                                    <span class="text-gray-400">Thời gian:</span>
                                    <span class="text-white">${new Date(alert.timestamp).toLocaleString('vi-VN')}</span>
                                </div>
                            </div>
                            ${alert.lastAttemptedEmail ? `
                                <div class="text-sm mt-2">
                                    <span class="text-gray-400">Email cuối:</span>
                                    <span class="text-yellow-300">${alert.lastAttemptedEmail}</span>
                                </div>
                            ` : ''}
                        </div>
                        <div class="flex space-x-2">
                            ${!alert.acknowledged ? `
                                <button onclick="acknowledgeAlert(${alert.id})" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm transition-colors">
                                    ✅ Xử lý
                                </button>
                            ` : ''}
                            <button onclick="viewAlertDetails(${alert.id})" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition-colors">
                                👁️ Chi tiết
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function loadBlockedIPs() {
            const container = document.getElementById('blockedIPsList');
            cleanExpiredThrottleData();
            
            const activeBlocks = Object.keys(blockedIPs).filter(ip => 
                blockedIPs[ip] && !blockedIPs[ip].unblocked
            );
            
            if (activeBlocks.length === 0) {
                container.innerHTML = '<div class="text-gray-300 text-center py-8">Không có IP nào bị chặn</div>';
                return;
            }
            
            container.innerHTML = activeBlocks.map(ip => {
                const blockInfo = blockedIPs[ip];
                const isCurrentlyBlocked = isIPBlocked(ip);
                const status = getIPStatus(ip);
                
                return `
                    <div class="bg-white/5 rounded-lg p-4 border-l-4 ${isCurrentlyBlocked ? 'border-red-500' : 'border-gray-500'}">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1">
                                <div class="flex items-center space-x-3 mb-2">
                                    <div class="text-white font-mono text-lg">${ip}</div>
                                    ${isCurrentlyBlocked ? 
                                        '<span class="bg-red-600 text-white px-2 py-1 rounded text-xs">🔒 Đang chặn</span>' :
                                        '<span class="bg-gray-600 text-white px-2 py-1 rounded text-xs">⏰ Hết hạn</span>'
                                    }
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <div class="text-gray-400">Lý do:</div>
                                        <div class="text-white">${blockInfo.reason}</div>
                                    </div>
                                    <div>
                                        <div class="text-gray-400">Lần thử:</div>
                                        <div class="text-red-300 font-bold">${blockInfo.attemptCount} lần</div>
                                    </div>
                                    <div>
                                        <div class="text-gray-400">Chặn lúc:</div>
                                        <div class="text-white">${new Date(blockInfo.blockedAt).toLocaleString('vi-VN')}</div>
                                    </div>
                                    ${isCurrentlyBlocked ? `
                                        <div>
                                            <div class="text-gray-400">Còn lại:</div>
                                            <div class="text-yellow-300 font-bold">${Math.ceil(status.timeUntilUnblock / 1000 / 60)} phút</div>
                                        </div>
                                    ` : `
                                        <div>
                                            <div class="text-gray-400">Trạng thái:</div>
                                            <div class="text-gray-400">Đã hết hạn tự động</div>
                                        </div>
                                    `}
                                </div>
                                ${blockInfo.lastAttemptedEmail ? `
                                    <div class="text-sm mt-2">
                                        <span class="text-gray-400">Email cuối:</span>
                                        <span class="text-yellow-300">${blockInfo.lastAttemptedEmail}</span>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="flex space-x-2">
                                ${isCurrentlyBlocked ? `
                                    <button onclick="unblockIPManual('${ip}')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm transition-colors">
                                        🔓 Mở chặn
                                    </button>
                                ` : ''}
                                <button onclick="viewIPHistory('${ip}')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition-colors">
                                    📋 Lịch sử
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadSecurityLogs(filter = 'all') {
            const container = document.getElementById('securityLogsList');
            const securityLogs = JSON.parse(localStorage.getItem('gameShopSecurityLogs') || '[]');
            
            let filteredLogs = securityLogs;
            if (filter !== 'all') {
                filteredLogs = securityLogs.filter(log => log.type === filter);
            }
            
            const sortedLogs = filteredLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, 100);
            
            if (sortedLogs.length === 0) {
                container.innerHTML = '<div class="text-gray-300 text-center py-8">Không có nhật ký nào</div>';
                return;
            }
            
            container.innerHTML = sortedLogs.map(log => `
                <div class="bg-white/5 rounded-lg p-3 border-l-4 ${getLogBorderColor(log.type)}">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3 mb-2">
                                <div class="text-white font-semibold">${getLogTypeIcon(log.type)} ${getLogTypeText(log.type)}</div>
                                <div class="text-gray-400 text-xs">${new Date(log.timestamp).toLocaleString('vi-VN')}</div>
                            </div>
                            <div class="text-gray-300 text-sm">
                                ${formatLogData(log)}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getAlertTypeIcon(type) {
            const icons = {
                'IP_BLOCKED': '🚨',
                'SUSPICIOUS_ACTIVITY': '⚠️',
                'SECURITY_BREACH': '🔥'
            };
            return icons[type] || '📋';
        }

        function getAlertTypeText(type) {
            const texts = {
                'IP_BLOCKED': 'IP bị chặn',
                'SUSPICIOUS_ACTIVITY': 'Hoạt động đáng ngờ',
                'SECURITY_BREACH': 'Vi phạm bảo mật'
            };
            return texts[type] || type;
        }

        function getLogTypeIcon(type) {
            const icons = {
                'login': '✅',
                'failed_login': '❌',
                'ip_blocked': '🚨',
                'ip_unblocked': '🔓',
                'password_reset': '🔑',
                'purchase': '💰'
            };
            return icons[type] || '📋';
        }

        function getLogTypeText(type) {
            const texts = {
                'login': 'Đăng nhập thành công',
                'failed_login': 'Đăng nhập thất bại',
                'ip_blocked': 'IP bị chặn',
                'ip_unblocked': 'IP được mở chặn',
                'password_reset': 'Đặt lại mật khẩu',
                'purchase': 'Mua hàng'
            };
            return texts[type] || type;
        }

        function getLogBorderColor(type) {
            const colors = {
                'login': 'border-green-500',
                'failed_login': 'border-red-500',
                'ip_blocked': 'border-red-600',
                'ip_unblocked': 'border-green-600',
                'password_reset': 'border-yellow-500',
                'purchase': 'border-blue-500'
            };
            return colors[type] || 'border-gray-500';
        }

        function formatLogData(log) {
            let result = '';
            if (log.data.email) result += `Email: ${log.data.email} `;
            if (log.data.ip) result += `IP: ${log.data.ip} `;
            if (log.data.userId) result += `User ID: ${log.data.userId} `;
            if (log.data.attemptCount) result += `Lần thử: ${log.data.attemptCount} `;
            if (log.data.blocked) result += `Bị chặn: ${log.data.blocked ? 'Có' : 'Không'} `;
            if (log.data.unblockedBy) result += `Mở chặn bởi: ${log.data.unblockedBy} `;
            return result || 'Không có thông tin chi tiết';
        }

        function acknowledgeAlert(alertId) {
            const alertIndex = securityAlerts.findIndex(alert => alert.id === alertId);
            if (alertIndex !== -1) {
                securityAlerts[alertIndex].acknowledged = true;
                securityAlerts[alertIndex].acknowledgedAt = new Date().toISOString();
                securityAlerts[alertIndex].acknowledgedBy = currentUser.email;
                
                saveIPThrottleData();
                loadSecurityAlerts();
                updateSecurityOverview();
                
                showToast('✅ Đã xử lý cảnh báo bảo mật', 'success');
            }
        }

        function unblockIPManual(ip) {
            if (unblockIP(ip)) {
                loadBlockedIPs();
                updateSecurityOverview();
                showToast(`🔓 Đã mở chặn IP ${ip}`, 'success');
            } else {
                showToast('Không thể mở chặn IP này', 'error');
            }
        }

        function manualBlockIP(event) {
            event.preventDefault();
            
            const ip = document.getElementById('manualBlockIPInput').value;
            const reason = document.getElementById('manualBlockReason').value;
            
            // Check if IP is already blocked
            if (isIPBlocked(ip)) {
                showToast('IP này đã bị chặn rồi', 'error');
                return;
            }
            
            // Block the IP manually
            blockedIPs[ip] = {
                blockedAt: Date.now(),
                reason: reason,
                attemptCount: 0,
                lastAttemptedEmail: '',
                unblocked: false,
                manualBlock: true,
                blockedBy: currentUser.email
            };
            
            // Create security alert
            const alert = {
                id: Date.now(),
                type: 'IP_BLOCKED',
                ip: ip,
                reason: `Manual block: ${reason}`,
                attemptCount: 0,
                lastAttemptedEmail: '',
                timestamp: new Date().toISOString(),
                acknowledged: false,
                manualBlock: true
            };
            
            securityAlerts.push(alert);
            
            // Log security event
            logSecurityEvent('ip_blocked', {
                ip: ip,
                reason: reason,
                manualBlock: true,
                blockedBy: currentUser.email,
                timestamp: new Date().toISOString()
            });
            
            saveIPThrottleData();
            
            // Reset form
            document.getElementById('manualBlockIPInput').value = '';
            document.getElementById('manualBlockReason').value = '';
            
            // Refresh displays
            loadBlockedIPs();
            updateSecurityOverview();
            
            showToast(`🚫 Đã chặn IP ${ip} thủ công`, 'success');
        }

        function filterSecurityLogs(filter) {
            // Update filter buttons
            document.querySelectorAll('.log-filter-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600');
                btn.classList.add('bg-white/20');
            });
            event.target.classList.remove('bg-white/20');
            event.target.classList.add('bg-blue-600');
            
            loadSecurityLogs(filter);
        }

        // Jiro file management functions
        function loadJiroTab() {
            updateJiroFileStats();
            loadRecentJiroEntries();
        }

        function updateJiroFileStats() {
            const jiroContent = JSON.parse(localStorage.getItem('jiroFileContent') || '[]');
            
            document.getElementById('jiroAccountCount').textContent = jiroContent.length;
            
            if (jiroContent.length > 0) {
                const lastEntry = jiroContent[jiroContent.length - 1];
                document.getElementById('jiroLastUpdate').textContent = new Date(lastEntry.createdAt).toLocaleString('vi-VN');
            } else {
                document.getElementById('jiroLastUpdate').textContent = 'Chưa có dữ liệu';
            }
        }

        function loadRecentJiroEntries() {
            const jiroContent = JSON.parse(localStorage.getItem('jiroFileContent') || '[]');
            const recentEntries = jiroContent.slice(-5).reverse(); // Get last 5 entries
            
            const container = document.getElementById('recentJiroEntries');
            
            if (recentEntries.length === 0) {
                container.innerHTML = '<div class="text-gray-300 text-center py-4">Chưa có dữ liệu nào trong file jiro.txt</div>';
                return;
            }
            
            container.innerHTML = recentEntries.map(entry => `
                <div class="bg-white/5 rounded-lg p-4 border-l-4 border-green-500">
                    <div class="flex justify-between items-start mb-2">
                        <div class="text-white font-semibold">${entry.email}</div>
                        <div class="text-gray-400 text-xs">${new Date(entry.createdAt).toLocaleString('vi-VN')}</div>
                    </div>
                    <div class="text-gray-300 text-sm mb-2">
                        <span class="text-gray-400">Hash Type:</span> ${entry.hashType}
                    </div>
                    <div class="text-green-300 font-mono text-xs bg-black/30 p-2 rounded break-all">
                        ${entry.passwordHash.substring(0, 50)}...
                    </div>
                    <div class="text-gray-400 text-xs mt-2">
                        Nguồn: ${entry.source}
                    </div>
                </div>
            `).join('');
        }

        function clearJiroFile() {
            const jiroContent = JSON.parse(localStorage.getItem('jiroFileContent') || '[]');
            
            if (jiroContent.length === 0) {
                showToast('File jiro.txt đã trống', 'error');
                return;
            }
            
            // Create confirmation modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white/10 backdrop-blur-md rounded-2xl p-8 max-w-md w-full mx-4">
                    <h3 class="text-2xl font-bold text-white mb-4 text-center">⚠️ Xác nhận xóa file</h3>
                    <div class="text-gray-300 mb-6 text-center">
                        <p class="mb-3">Bạn có chắc muốn xóa toàn bộ nội dung file jiro.txt?</p>
                        <div class="bg-red-900/30 border border-red-500/30 rounded-lg p-3">
                            <p class="text-red-300 text-sm font-semibold">🚨 CẢNH BÁO:</p>
                            <p class="text-red-200 text-sm">• Sẽ xóa ${jiroContent.length} mục dữ liệu</p>
                            <p class="text-red-200 text-sm">• Hành động này không thể hoàn tác</p>
                            <p class="text-red-200 text-sm">• Tất cả mật khẩu băm sẽ bị mất</p>
                        </div>
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-lg font-semibold transition-colors">
                            Hủy
                        </button>
                        <button onclick="confirmClearJiroFile(); this.parentElement.parentElement.parentElement.remove();" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg font-semibold transition-colors">
                            Xóa toàn bộ
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function confirmClearJiroFile() {
            const jiroContent = JSON.parse(localStorage.getItem('jiroFileContent') || '[]');
            const deletedCount = jiroContent.length;
            
            // Clear the file content
            localStorage.setItem('jiroFileContent', '[]');
            localStorage.setItem('jiroFileText', '');
            
            // Update UI
            updateJiroFileStats();
            loadRecentJiroEntries();
            
            showToast(`🗑️ Đã xóa ${deletedCount} mục dữ liệu khỏi file jiro.txt`, 'success');
        }

        // Auto-save user activity and security monitoring
        setInterval(() => {
            if (currentUser) {
                validateSession();
                checkAccountSecurity();
                updateMessageCount();
                
                // Update security overview if admin is viewing security tab
                if (currentUser.role === 'admin' && document.getElementById('adminSecurity') && !document.getElementById('adminSecurity').classList.contains('hidden')) {
                    updateSecurityOverview();
                }
            }
            
            // Clean expired throttle data periodically
            cleanExpiredThrottleData();
        }, 60000); // Check every minute

        // Initialize the app when page loads
        showPage('home');
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9951bbf3a2b4e8cb',t:'MTc2MTU2MzI5My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>